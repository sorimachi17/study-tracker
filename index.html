<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
  <title>Study Log</title>
  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--text:#dfe6ee;--muted:#98a2b3;
      --accent:#4ea46e;--accent-2:#2c7a4a;--danger:#f25f5c;
      --chip:#232834;--chip-muted:#545e70;--chip-text:#fff;
      --lvl0:#2a2e36;--lvl1:#284e32;--lvl2:#2f6e3e;--lvl3:#2f8e4a;--lvl4:#31a65a;
      --goalhist-bg:#16191e;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb;--card:#fff;--text:#111;--muted:#667085;
        --accent:#2ea043;--accent-2:#1f7a32;--danger:#f25f5c;
        --chip:#e6f4ea;--chip-muted:#c2c7cf;--chip-text:#1a2a15;
        --lvl0:#ebedf0;--lvl1:#c6e48b;--lvl2:#7bc96f;--lvl3:#239a3b;--lvl4:#196127;
        --goalhist-bg:#f4f5f8;
      }
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);background:var(--bg);line-height:1.5;overflow-y:auto;
    }
    body.menu-open{overflow:hidden;} /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼å±•é–‹ä¸­ã¯èƒŒé¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */

    header{
      position:sticky;top:0;z-index:40;background:var(--bg);
      padding:12px 12px 8px;border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:center;gap:8px;min-height:56px;
    }
    h1{margin:0;font-size:18px;flex:1}

    /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ï¼ˆè§’ã®ä¸¸ã„å››è§’ï¼‰ */
    #menuBtn{
      width:40px;height:40px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      background:var(--card);color:var(--text);font-size:18px;cursor:pointer;
    }
    @media (prefers-color-scheme: light){
      #menuBtn{border-color:#e5e7eb;background:#fff;color:#111}
    }

    /* PCå‘ã‘ã‚¿ãƒ– */
    .tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    @media (max-width:640px){.tabs{display:none}}
    @media (min-width:641px){#menuBtn,#menuPanel,#menuBackdrop{display:none!important}}
    .tab-btn{
      border:1px solid rgba(255,255,255,.12);background:var(--card);color:var(--text);
      padding:7px 13px;border-radius:999px;font-size:13px;white-space:nowrap;
    }
    .tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(78,164,110,.2) inset}
    .tab-btn.right{margin-left:auto}

    /* ãƒ¢ãƒã‚¤ãƒ«ï¼šé‡ã­ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆæŠ¼ã—ä¸‹ã’ãªã—ï¼‰ */
    #menuBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      opacity:0;pointer-events:none;transition:.2s;z-index:45;
    }
    #menuBackdrop.show{opacity:1;pointer-events:auto;}
    #menuPanel{
      position:fixed;left:8px;right:8px;top:64px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ã«é‡ã­ã‚‹ */
      background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:14px;
      padding:12px;box-shadow:0 12px 34px rgba(0,0,0,.35);
      z-index:50;display:none;flex-direction:column;gap:10px;
      max-height:calc(100dvh - 88px);overflow:auto;
    }
    #menuPanel.open{display:flex;}
    .m-item{
      height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:var(--card);color:var(--text);font-size:14px;
      display:flex;align-items:center;justify-content:center;text-decoration:none;cursor:pointer;
    }
    .m-item.primary{background:var(--accent);border:none;color:#fff;font-weight:600}
    @media (prefers-color-scheme: light){
      #menuPanel{border-color:#e5e7eb}
      .m-item{border-color:#e5e7eb;background:#fff;color:#111}
    }

    main{padding:12px;max-width:980px;margin:0 auto}
    section{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-bottom:12px;}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}

    /* å…¥åŠ›ã®çµ±ä¸€ï¼ˆé«˜ã•48pxï¼‰ */
    input,select,button,textarea{
      width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:#0e1016;color:var(--text);font-size:16px;display:block;
    }
    @media (prefers-color-scheme: light){
      input,select,button,textarea{background:#fff;color:#111;border-color:#e5e7eb}
    }
    input[type="date"]{
      -webkit-appearance:none;appearance:none;position:relative;
      padding-right:44px;margin:0;background-clip:padding-box;height:48px;
    }
    input[type="date"]::-webkit-date-and-time-value{ text-align:left; line-height:normal; }
    input[type="date"]::-webkit-calendar-picker-indicator{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
    }
    /* time ã®ä¸­å¤®å¯„ã›ï¼ˆiOS/Safariå¯¾å¿œï¼‰ */
    input[type="time"]{
      -webkit-appearance:none;appearance:none;height:48px;min-width:120px;max-width:160px;
      text-align:center;padding:0 10px;font-size:16px;line-height:48px;
    }
    input[type="time"]::-webkit-datetime-edit{ padding:0; }
    input[type="time"]::-webkit-datetime-edit-fields-wrapper{ display:flex; align-items:center; }
    input[type="time"]::-webkit-date-and-time-value{ text-align:center; }

    .summary-card{background:var(--card);border:1.5px solid var(--accent);border-radius:14px;margin-bottom:18px;padding:18px 14px 12px;display:flex;flex-direction:column;gap:8px;font-size:15px;}
    .summary-kpi{font-size:26px;font-weight:700}
    .summary-list{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
    @media (max-width:600px){.summary-list{grid-template-columns:1fr}}
    .summary-progress-bar{width:100%;height:11px;border-radius:7px;background:var(--lvl0);margin:10px 0 4px;overflow:hidden}
    .summary-progress-bar-inner{height:100%;border-radius:7px;background:var(--accent);transition:.25s;width:0}

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .calendar-head{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;margin-bottom:8px;justify-content:center;}
    .calendar-nav-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;border:none;background:var(--lvl0);font-size:19px;cursor:pointer;transition:.15s;margin:0 3px;}
    .calendar-nav-select{height:32px;border-radius:6px;background:var(--lvl0);color:var(--text);border:none;padding:0 4px;font-size:14px;margin:0 3px;width:72px;}
    .calendar-title-btn{font-size:17px;font-weight:700;cursor:pointer;padding:3px 10px;border-radius:6px;transition:background .15s;min-width:120px;text-align:center;}
    .calendar-grid{display:grid;gap:4px;grid-template-columns:repeat(7, minmax(0,1fr));}
    #dowRow{display:grid;grid-template-columns:repeat(7, minmax(0,1fr));gap:4px;margin-bottom:4px;}
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .day{aspect-ratio:1/1;border-radius:6px;padding:4px;display:flex;flex-direction:column;justify-content:space-between;background:var(--lvl0);cursor:pointer;overflow:hidden;}
    .day .num{line-height:1;font-size:12px}
    .day .mins{line-height:1;font-size:11px;white-space:nowrap;overflow:hidden}
    .lvl0{background:var(--lvl0)} .lvl1{background:var(--lvl1)} .lvl2{background:var(--lvl2)} .lvl3{background:var(--lvl3)} .lvl4{background:var(--lvl4)}
    .day.today{outline:2px solid var(--accent);outline-offset:0}
    @supports not (aspect-ratio: 1 / 1){
      .day{position:relative}
      .day::before{content:"";display:block;padding-top:100%}
      .day>*{position:absolute;inset:6px}
    }

    /* å¹´é–“ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .year-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;}
    .mini-month{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:4px;cursor:pointer;}
    .mini-month-name{text-align:center;font-size:12px;color:var(--muted);margin-bottom:2px;}
    .mini-month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
    .mini-day{aspect-ratio:1/1;font-size:9px;border-radius:2px;display:flex;align-items:center;justify-content:center;}
    .mini-day.today{outline:1px solid var(--accent);}

    /* é€±ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆåˆ—ã‚ºãƒ¬è§£æ¶ˆï¼‰ */
    .week-heatmap{display:grid;grid-template-columns:44px repeat(7, minmax(0,1fr));gap:2px;font-size:10px;margin-top:6px}
    .week-heatmap .cell{height:12px;border-radius:2px}
    .week-heatmap .week-date{cursor:pointer;height:18px;display:flex;align-items:center;justify-content:center}
    .week-heatmap .hour-label{display:flex;align-items:center;justify-content:center;height:18px;color:var(--muted)}

    /* æ—¥åˆ¥è©³ç´° */
    .day-detail-wrap{background:var(--card);border-radius:11px;margin-bottom:10px;box-shadow:0 2px 10px rgba(30,40,45,0.06);border:1.5px solid var(--lvl0);padding:18px 15px 8px 15px;max-width:440px;}
    .day-detail-title{font-size:19px;font-weight:600;margin-bottom:2px;letter-spacing:0.5px;}
    .day-detail-total{font-size:14px;color:var(--muted);margin-bottom:10px;}
    .day-detail-list .rec-row{
      display:flex;align-items:center;gap:8px;background:var(--lvl0);
      border-radius:8px;padding:6px 8px;margin-bottom:6px;border:1px solid rgba(255,255,255,.07);
    }
    .day-detail-list .rec-row .chip{
      min-width:56px;max-width:110px;white-space:nowrap;padding:3px 11px;font-size:13px;
      margin-right:4px;border-radius:12px;background:var(--chip-muted);color:var(--chip-text);
      text-align:center;height:28px;display:flex;align-items:center;justify-content:center;
    }
    .day-detail-list .rec-row .del-btn{
      padding:0 11px;min-width:0;font-size:15px;border-radius:7px;background:var(--muted);
      color:var(--bg);border:none;margin-left:auto;transition:.2s;height:28px;line-height:1;display:flex;align-items:center;justify-content:center;width:38px;
    }

    /* ç›®æ¨™ã‚«ãƒ¼ãƒ‰ */
    .goal-card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;margin-bottom:12px;}
    .goal-list-card{margin-top:0;}
    .goal-hist-item{
      background:var(--goalhist-bg);border-radius:12px;margin-bottom:12px;padding:16px 15px 12px 15px;
      box-shadow:0 2px 10px rgba(30,40,45,0.07);border:1px solid rgba(100,150,110,0.10);max-width:440px;display:flex;flex-direction:column;gap:6px;
    }
    .goal-hist-period{font-size:15px;font-weight:600;margin-bottom:0;letter-spacing:0.2px;}
    .goal-hist-kpis{display:flex;gap:18px;flex-wrap:wrap;font-size:14px;margin:2px 0 0 2px;}
    .goal-hist-kpis .gh-kpi{color:var(--muted);}
    .goal-hist-del-btn{
      align-self:flex-end;padding:2px 11px;border-radius:8px;background:var(--muted);
      color:var(--bg);border:none;font-size:13px;margin-top:4px;transition:.2s;
    }

    /* ã‚«ãƒ†ã‚´ãƒªç®¡ç† */
    .cat-btn{height:28px;width:36px;min-width:36px;border-radius:8px;padding:0;font-size:13px;}
    .cat-list-row{display:flex;align-items:center;gap:6px;padding:7px 0;border-bottom:1px solid rgba(180,180,180,.11);}
    .cat-chip{flex:1;min-width:120px;display:flex;align-items:center;justify-content:center;padding:5px 8px;font-size:14px;height:28px;border-radius:12px;background:var(--chip-muted);color:var(--chip-text);white-space:nowrap;}

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å‘¨ã‚Š */
    .flex-split{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;}
    .calendar-card,.records-card{flex:1;min-width:260px;}
    .records-card{
      background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:14px;
      box-shadow:0 2px 10px rgba(30,40,45,0.07);
      min-height:300px; /* æ—¥ä»˜ãŒç©ºã§ã‚‚ç¸®ã¾ãªã„ */
    }
    select{height:48px;}
    .minutes-block{flex:0 0 140px;}
    .date-block{flex:1;min-width:160px;}
    .form-row-flex{display:flex;gap:12px;align-items:flex-end;margin-bottom:8px;flex-wrap:wrap;}
    @media (max-width:600px){
      .form-row-flex{flex-direction:column;align-items:stretch;gap:4px;}
      .minutes-block{flex:1 1 0;}
    }
    .time-input-row{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      margin-top:0;
      margin-bottom:8px;
    }
    .time-fields{display:flex;gap:8px;flex:1 1 0;min-width:0;align-items:center;}

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#11161c;color:#dfe6ee;padding:10px 14px;border:1px solid rgba(255,255,255,.08);border-radius:999px;opacity:0;pointer-events:none;transition:.25s;z-index:60}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“˜ Study Log</h1>
    <button id="menuBtn" type="button" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>

    <!-- PC è¡¨ç¤ºç”¨ã‚¿ãƒ–ï¼ˆdata-tab ã¯åŒä¸€ãƒšãƒ¼ã‚¸ã€a[href] ã¯å¤–éƒ¨é·ç§»ï¼‰ -->
    <div class="tabs" id="tabs">
      <button class="tab-btn active" type="button" data-tab="main">ãƒ¡ã‚¤ãƒ³</button>
      <button class="tab-btn" type="button" data-tab="goal">ç›®æ¨™</button>
      <button class="tab-btn" type="button" data-tab="cats">ã‚«ãƒ†ã‚´ãƒª</button>
      <!-- å¤–éƒ¨ãƒšãƒ¼ã‚¸ä¾‹ï¼š<a class="tab-btn" href="/another.html">åˆ¥ãƒšãƒ¼ã‚¸</a> -->
      <button class="tab-btn right" type="button" id="exportBtn" title="JSONã§æ›¸ãå‡ºã—">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="tab-btn" type="button" id="importBtn" title="JSONã‚’èª­ã¿è¾¼ã¿">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>
  </header>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="menuBackdrop"></div>
  <nav id="menuPanel" aria-hidden="true">
    <button class="m-item" type="button" data-tab="main">ãƒ¡ã‚¤ãƒ³</button>
    <button class="m-item" type="button" data-tab="goal">ç›®æ¨™</button>
    <button class="m-item" type="button" data-tab="cats">ã‚«ãƒ†ã‚´ãƒª</button>
    <!-- å¤–éƒ¨ãƒšãƒ¼ã‚¸ä¾‹ï¼š<a class="m-item" href="/goals.html">åˆ¥ãƒšãƒ¼ã‚¸ï¼ˆä¾‹ï¼‰</a> -->
    <button class="m-item" type="button" id="mExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="m-item" type="button" id="mImport">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  </nav>

  <main>
    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <section id="tab-main">
      <div id="summaryCard" class="summary-card">
        <div id="summaryGoalTabs" class="tabs" style="margin-bottom:6px;"></div>
        <div id="summaryContent"></div>
      </div>

      <div class="flex-split">
        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="calendar-card">
          <div class="calendar-head" id="calendarNav">
            <button id="prevMonth" class="calendar-nav-btn" title="å‰ã®æœˆ">&lt;</button>
            <div id="monthTitle" class="calendar-title-btn" title="æœˆã‚’é¸æŠ"></div>
            <button id="nextMonth" class="calendar-nav-btn" title="æ¬¡ã®æœˆ">&gt;</button>
            <button id="prevYear" class="calendar-nav-btn" style="display:none" title="å‰å¹´">&lt;</button>
            <div id="yearTitle" class="calendar-title-btn" style="display:none"></div>
            <button id="nextYear" class="calendar-nav-btn" style="display:none" title="ç¿Œå¹´">&gt;</button>
            <button id="prevWeek" class="calendar-nav-btn" style="display:none" title="å‰ã®é€±">&lt;</button>
            <div id="weekTitle" class="calendar-title-btn" style="display:none"></div>
            <button id="nextWeek" class="calendar-nav-btn" style="display:none" title="æ¬¡ã®é€±">&gt;</button>
            <select id="calendarView" class="calendar-nav-select" aria-label="è¡¨ç¤º">
              <option value="year">å¹´</option>
              <option value="month" selected>æœˆ</option>
              <option value="week">é€±</option>
            </select>
          </div>
          <div class="calendar-grid" id="dowRow"></div>
          <div class="calendar-grid" id="monthGrid"></div>
          <div id="dayDetails" style="margin-top:10px"></div>
          <div id="yearView" style="display:none">
            <div id="yearGrid" class="year-grid"></div>
          </div>
          <div id="weekView" style="display:none"></div>
        </div>

        <!-- è¨˜éŒ² -->
        <div class="records-card">
          <form id="entryForm">
            <div class="form-row-flex">
              <div class="date-block">
                <label>æ—¥ä»˜</label>
                <input type="date" id="date" required>
              </div>
              <div>
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="category"></select>
              </div>
              <div class="minutes-block">
                <label>å‹‰å¼·æ™‚é–“ (m)</label>
                <input type="text" id="minutes" placeholder="ä¾‹: 45" required autocomplete="off">
              </div>
            </div>
            <div class="time-input-row">
              <label style="font-size:12px;color:var(--muted)">é–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»</label>
              <div class="time-fields">
                <input type="time" id="startTime" step="60">
                <span style="line-height:1.8;">ï½</span>
                <input type="time" id="endTime" step="60">
              </div>
            </div>
            <div class="entry-submit-row">
              <button type="submit" class="m-item primary" style="height:48px;border-radius:12px">è¨˜éŒ²ã™ã‚‹</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- ç›®æ¨™ -->
    <div id="tab-goal" style="display:none">
      <section class="goal-card">
        <form id="goalForm">
          <div class="row">
            <div><label>é–‹å§‹æ—¥</label><input type="date" id="goalStart" required></div>
            <div><label>çµ‚äº†æ—¥</label><input type="date" id="goalEnd" required></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label>ç›®æ¨™æ™‚é–“ (h)</label><input type="number" id="goalHours" min="1" placeholder="ä¾‹: 100" required></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div><label>ã‚«ãƒ†ã‚´ãƒª</label><select id="goalCategory"></select></div>
          </div>
          <div style="display:flex;gap:14px;justify-content:space-between;margin-top:14px;margin-bottom:18px;">
            <button class="m-item primary" type="submit">ä¿å­˜</button>
            <button class="m-item" type="button" id="goalDeleteBtn">å‰Šé™¤</button>
          </div>
        </form>
        <div id="activeGoalList" class="goal-list-card" style="margin-top:10px"></div>
      </section>
      <section class="goal-card">
        <div class="goal-list-card" id="goalHistory"></div>
      </section>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒª -->
    <section id="tab-cats" style="display:none">
      <div class="row">
        <div><label>æ–°è¦ã‚«ãƒ†ã‚´ãƒªå</label><input type="text" id="newCat" placeholder="ä¾‹: IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°"></div>
        <div style="align-self:end"><button id="addCat" class="m-item primary" type="button">è¿½åŠ </button></div>
      </div>
      <div style="margin-top:8px" id="catList" class="list"></div>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button id="resetData" class="m-item" type="button">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
    </section>
  </main>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toast" class="toast"></div>

  <!-- æœˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ -->
  <div id="monthModal" class="modal-bg" style="display:none">
    <div class="modal-content">
      <label>å¹´æœˆã‚’é¸æŠ</label>
      <div style="margin-top:8px;">
        <select id="selectYear"></select>
        <select id="selectMonth"></select>
      </div>
      <div class="modal-actions">
        <button class="m-item" id="closeMonthModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="m-item primary" id="gotoMonthBtn">ç§»å‹•</button>
      </div>
    </div>
  </div>

  <script>
  (()=> {
    // ----- åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    const KEYS = {entries:'studyEntries_v7',cats:'studyCategories_v7',goals:'studyGoals_v7'};
    const pad = n => String(n).padStart(2,'0');
    const fmtTime = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const todayStr = () => { const d=new Date(); return [d.getFullYear(),pad(d.getMonth()+1),pad(d.getDate())].join('-'); };
    const fmtDateLabel = d => `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
    const parseDateStr = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d,0,0,0,0); };
    const dateToStr = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const toast = msg => { const t=document.getElementById('toast'); if(!t) return; t.textContent=msg||'ä¿å­˜ã—ã¾ã—ãŸ'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
    const load = (k,fallback)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return v??fallback }catch(e){ return fallback } };
    const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

    let entries=load(KEYS.entries,[]),
        categories=load(KEYS.cats,['IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°','å˜èª','ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°','ãƒªã‚¹ãƒ‹ãƒ³ã‚°','æ–‡æ³•','ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°']),
        goals=load(KEYS.goals,[]);

    const latestGoal = ()=> goals.length ? goals[goals.length-1] : null;
    const startOfWeek = d => { const t=new Date(d); const diff=(t.getDay()+6)%7; t.setDate(t.getDate()-diff); t.setHours(0,0,0,0); return t; };
    const fmtWeekLabel = start => { const end=new Date(start); end.setDate(start.getDate()+6); return `${start.getFullYear()}/${start.getMonth()+1}/${start.getDate()}ã€œ${end.getMonth()+1}/${end.getDate()}`; };
    let currentWeekStart=startOfWeek(new Date());
    let summaryGoalIndex=0;
    const activeGoals=()=>{
      const today=new Date();today.setHours(0,0,0,0);
      return goals.filter(g=>parseDateStr(g.start)<=today && parseDateStr(g.end)>=today);
    };
    const pastGoals=()=>{
      const today=new Date();today.setHours(0,0,0,0);
      return goals.filter(g=>parseDateStr(g.end)<today);
    };
    const fmt=(n,d)=>Number(n).toLocaleString('en-US',d!==undefined?{minimumFractionDigits:d,maximumFractionDigits:d}:{});    

    // ----- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆé‡ã­ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
    const body = document.body;
    const menuBtn = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    const backdrop = document.getElementById('menuBackdrop');

    const openMenu = ()=>{ menuPanel.classList.add('open'); backdrop.classList.add('show'); body.classList.add('menu-open'); };
    const closeMenu = ()=>{ menuPanel.classList.remove('open'); backdrop.classList.remove('show'); body.classList.remove('menu-open'); };

    menuBtn.addEventListener('click', ()=>{
      if(menuPanel.classList.contains('open')) closeMenu(); else openMenu();
    });
    backdrop.addEventListener('click', closeMenu);

    // å¤–éƒ¨ãƒªãƒ³ã‚¯(<a>)ã¯ãã®ã¾ã¾é·ç§»ã€data-tab ã¯ SPA åˆ‡æ›¿
    menuPanel.addEventListener('click', (e)=>{
      const a = e.target.closest('a[href]');
      if(a){ closeMenu(); return; } // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé·ç§»
      const t = e.target.closest('[data-tab]');
      if(t){ setTab(t.dataset.tab); closeMenu(); }
    });

    // PC ç”¨ã‚¿ãƒ–
    const tabsEl=document.getElementById('tabs');
    tabsEl.addEventListener('click',e=>{
      const a = e.target.closest('a[href]');
      if(a){ return; } // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé·ç§»
      const t=e.target.closest('.tab-btn[data-tab]');
      if(!t) return;
      e.preventDefault();
      setTab(t.dataset.tab);
    });

    // ----- Export/Importï¼ˆPC/ãƒ¢ãƒã‚¤ãƒ«ï¼‰
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const mExport = document.getElementById('mExport');
    const mImport = document.getElementById('mImport');

    function doExport(){
      const data={entries,categories,goals,exportedAt:new Date().toISOString()};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download=`study_backup_${Date.now()}.json`;a.click();URL.revokeObjectURL(a.href);
      toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
    }
    function askImport(){ importFile.click(); }
    exportBtn.addEventListener('click',doExport);
    mExport.addEventListener('click',()=>{ doExport(); closeMenu(); });
    importBtn.addEventListener('click',askImport);
    mImport.addEventListener('click',()=>{ askImport(); closeMenu(); });
    importFile.addEventListener('change',async()=>{
      const f=importFile.files[0]; if(!f) return; const text=await f.text();
      try{
        const data=JSON.parse(text); if(!data||!Array.isArray(data.entries)) throw new Error('ä¸æ­£ãªå½¢å¼');
        entries=data.entries; categories=data.categories||categories; goals=data.goals||[];
        save(KEYS.entries,entries); save(KEYS.cats,categories); save(KEYS.goals,goals);
        renderAll(); toast('èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
      }catch(err){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—: '+err.message); }
      finally{ importFile.value=''; }
    });

    // ----- ã‚¿ãƒ–åˆ¶å¾¡
    const sections={main:document.getElementById('tab-main'),goal:document.getElementById('tab-goal'),cats:document.getElementById('tab-cats')};
    function setTab(name){
      [...tabsEl.querySelectorAll('.tab-btn[data-tab]')].forEach(b=>b.classList.toggle('active',b.dataset.tab===name));
      Object.entries(sections).forEach(([k,sec])=>{sec.style.display=(k===name)?'block':'none';});
      if(name==='main'){renderSummary();renderWeek();renderMonth();}
      if(name==='goal'){renderGoal();renderActiveGoals();renderGoalHistory();}
      if(name==='cats'){renderCats();}
    }
    document.getElementById('summaryGoalTabs').addEventListener('click',e=>{
      const i=e.target?.dataset?.selgoal;
      if(i!==undefined){summaryGoalIndex=Number(i);renderSummary();}
    });

    // ----- ã‚µãƒãƒªãƒ¼
    function estimateGoalETA(goal, achievedMin){
      const target = goal?.targetMin || 0;
      if(!goal || !target) return { text:'â€”' };
      if(achievedMin >= target) return { text:'é”æˆæ¸ˆã¿' };
      const s = parseDateStr(goal.start);
      const e = parseDateStr(goal.end);
      const today = new Date();
      const until = new Date(Math.min(e.getTime(), today.getTime()));
      const elapsedDays = Math.max(1, Math.floor((until - s)/86400000) + 1);
      const ratio = achievedMin / target;
      if(ratio <= 0) return { text:'â€”' };
      const estDays = Math.ceil(elapsedDays * (1 - ratio) / ratio);
      const eta = new Date(today);
      eta.setDate(today.getDate() + estDays);
      return { text: `${estDays}æ—¥å¾Œï¼ˆ${eta.getFullYear()}/${pad(eta.getMonth()+1)}/${pad(eta.getDate())}ï¼‰`, eta };
    }

    function renderSummary() {
      const wrap=document.getElementById('summaryContent');
      const tabWrap=document.getElementById('summaryGoalTabs');
      if(!entries.length){wrap.innerHTML='<div class="muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';tabWrap.innerHTML='';return;}
      const goalsAct=activeGoals().slice();
      if(summaryGoalIndex>=goalsAct.length) summaryGoalIndex=0;
      tabWrap.innerHTML=goalsAct.map((g,i)=>`<button class="tab-btn ${i===summaryGoalIndex?'active':''}" data-selgoal="${i}">${g.category&&g.category!=='all'?g.category:'ç·åˆ'}</button>`).join('');
      const goal=goalsAct[summaryGoalIndex];

      let totalMin = entries.reduce((a,b)=>a+b.minutes,0);
      if(goal && goal.start && goal.end){
        const s=parseDateStr(goal.start),e=parseDateStr(goal.end);
        totalMin = entries.filter(x=>{
          const d=parseDateStr(x.date);
          return d>=s&&d<=e && (goal.category==='all' || !goal.category || x.category===goal.category);
        }).reduce((a,b)=>a+b.minutes,0);
      }
      const totalH = fmt(totalMin/60,1);

      const rangeEntries = entries.filter(x=>{
        if(goal && goal.start && goal.end){
          const d=parseDateStr(x.date);
          if(d<parseDateStr(goal.start)||d>parseDateStr(goal.end)) return false;
        }
        return true;
      });
      const catTotals={}; rangeEntries.forEach(e=>{catTotals[e.category]=(catTotals[e.category]||0)+e.minutes;});

      let days = 1, goalPeriod = "";
      if(goal && goal.start && goal.end){
        const s=parseDateStr(goal.start), today=new Date(), until=new Date(Math.min(parseDateStr(goal.end), today));
        days = Math.max(1, Math.floor((until - s)/86400000) + 1);
        goalPeriod = `<span class="muted" style="font-size:12px;display:block;margin-top:3px;">ç›®æ¨™æœŸé–“ï¼š${goal.start}ã€œ${goal.end}</span>`;
      }

      let tgt = 0, pct = 0, predict = '';
      if (goal) {
        tgt = goal.targetMin;
        pct = Math.min(100, Math.round((totalMin / Math.max(1,tgt))*100));
        predict = estimateGoalETA(goal, totalMin).text;
      }

      wrap.innerHTML =
        `<div class="summary-kpi">åˆè¨ˆ <span style="font-weight:700">${totalH}</span> h  (${fmt(totalMin)} m)</div>
         <div class="summary-progress-bar"><div class="summary-progress-bar-inner" id="mainProgressBar"></div></div>
         <div class="summary-list">
           <div>é–‹å§‹ã‹ã‚‰ <span style="font-weight:600">${fmt(days)}</span> æ—¥ç›®${goalPeriod}</div>
           <div>ç›®æ¨™ï¼š${tgt?fmt(tgt/60,1)+'h':'â€”'}ï¼ˆé”æˆç‡${fmt(pct||0)}%ï¼‰</div>
           <div>ç›®æ¨™åˆ°é”äºˆæ¸¬ï¼š${predict||'â€”'}</div>
         </div>
         <div class="summary-list" style="margin-top:4px;">
           ${Object.entries(catTotals).map(([c,v])=>`<div>${c}: <b>${fmt(v/60,1)}</b>h</div>`).join('')}
         </div>`;
      const bar = document.getElementById('mainProgressBar');
      bar.style.width = (goal?Math.min(100, Math.round((totalMin / Math.max(1,goal.targetMin))*100)):0) + '%';
    }

    // ----- é€±ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
    function weekHeatmapHTML(start){
      const heat=Array.from({length:7},()=>Array(24).fill(0));
      for(let i=0;i<7;i++){
        const d=new Date(start.getFullYear(),start.getMonth(),start.getDate()+i);
        const key=dateToStr(d);
        const list=entries.filter(e=>e.date===key);
        list.forEach(e=>{
          if(!e.startTime||!e.endTime)return;
          const [sh,sm]=e.startTime.split(':').map(Number);
          const [eh,em]=e.endTime.split(':').map(Number);
          let st=sh*60+sm,et=eh*60+em;
          for(let h=0;h<24;h++){
            const hs=h*60,he=(h+1)*60;
            const overlap=Math.max(0,Math.min(et,he)-Math.max(st,hs));
            heat[i][h]+=overlap;
          }
        });
      }
      const groups=2,groupCount=24/groups;const heatAgg=Array.from({length:7},()=>Array(groupCount).fill(0));
      for(let d=0;d<7;d++){for(let h=0;h<24;h++){const g=Math.floor(h/groups);heatAgg[d][g]+=heat[d][h];}}
      const max=heatAgg.flat().reduce((a,b)=>Math.max(a,b),0);
      let html='<div class="week-heatmap"><div></div>';
      for(let i=0;i<7;i++){
        const d=new Date(start);d.setDate(start.getDate()+i);const ds=dateToStr(d);
        html+=`<div class="week-date" data-date="${ds}">${pad(d.getMonth()+1)}/${pad(d.getDate())}</div>`;
      }
      for(let g=0;g<groupCount;g++){
        const label=`${pad(g*groups)}-${pad(g*groups+groups)}`;
        html+=`<div class="hour-label">${label}</div>`;
        for(let d=0;d<7;d++){
          const day=new Date(start);day.setDate(start.getDate()+d);const ds=dateToStr(day);
          const v=heatAgg[d][g];
          const lvl=v===0?0:Math.min(4,Math.ceil((v/(max||1))*4));
          html+=`<div class="cell lvl${lvl}" data-date="${ds}"></div>`;
        }
      }
      html+='</div>';
      return html;
    }
    function renderWeek(){
      weekView.innerHTML = weekHeatmapHTML(currentWeekStart);
      weekTitle.textContent = fmtWeekLabel(currentWeekStart);
      // CSS ã‚°ãƒªãƒƒãƒ‰é©ç”¨å¾Œã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¢ºå®šï¼ˆå¾®å°ã‚ºãƒ¬é˜²æ­¢ï¼‰
      requestAnimationFrame(()=>{ weekView.style.contain = 'layout'; });
    }

    // ----- ã‚«ãƒ†ã‚´ãƒªé¸æŠ
    const catSel=document.getElementById('category');
    const goalCatSel=document.getElementById('goalCategory');
    function renderCategorySelect(){
      catSel.innerHTML='';
      goalCatSel.innerHTML='<option value="all">å…¨ã¦</option>';
      categories.forEach(c=>{
        const o=document.createElement('option');o.value=c;o.textContent=c;catSel.appendChild(o);
        const g=document.createElement('option');g.value=c;g.textContent=c;goalCatSel.appendChild(g);
      });
    }

    // ----- è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
    const form=document.getElementById('entryForm'),
          dateEl=document.getElementById('date'),
          minEl=document.getElementById('minutes'),
          startEl=document.getElementById('startTime'),
          endEl=document.getElementById('endTime');

    function estimateTimes(){
      const mins=Number(minEl.value||0);if(!mins){return;}
      const end=new Date(),start=new Date(end.getTime()-mins*60000);
      startEl.value=fmtTime(start);endEl.value=fmtTime(end);
    }
    minEl.addEventListener('input',estimateTimes);
    dateEl.addEventListener('change',estimateTimes);

    function updateEndFromStart(){
      const mins=Number(minEl.value||0);if(!mins||!startEl.value)return;
      const [h,m]=startEl.value.split(':').map(Number);
      const start=new Date();start.setHours(h,m,0,0);
      const end=new Date(start.getTime()+mins*60000);
      endEl.value=fmtTime(end);
    }
    function updateStartFromEnd(){
      const mins=Number(minEl.value||0);if(!mins||!endEl.value)return;
      const [h,m]=endEl.value.split(':').map(Number);
      const end=new Date();end.setHours(h,m,0,0);
      const start=new Date(end.getTime()-mins*60000);
      startEl.value=fmtTime(start);
    }
    startEl.addEventListener('input',updateEndFromStart);
    endEl.addEventListener('input',updateStartFromEnd);

    form.addEventListener('submit',e=>{
      e.preventDefault();
      const minutes=Number(minEl.value),cat=catSel.value,st=startEl.value,endt=endEl.value;
      if(!minutes||minutes<=0||!cat)return;
      const dStr = dateEl.value||todayStr();
      entries.push({id:Date.now().toString(36),date:dStr,minutes,category:cat,createdAt:Date.now(),startTime:st,endTime:endt});
      save(KEYS.entries,entries);
      minEl.value='';estimateTimes();toast('ä¿å­˜ã—ã¾ã—ãŸ');
      renderSummary();renderWeek();renderMonth();renderYear();renderGoal();renderActiveGoals();renderGoalHistory();
      setCalendarView(calendarViewSel.value);
      if(activeDayDetail) renderDayDetails(activeDayDetail);
    });

    // ----- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å‘¨ã‚Š
    const dowRow=document.getElementById('dowRow'),
          monthGrid=document.getElementById('monthGrid'),
          monthTitle=document.getElementById('monthTitle'),
          prevMonthBtn=document.getElementById('prevMonth'),
          nextMonthBtn=document.getElementById('nextMonth'),
          dayDetails=document.getElementById('dayDetails'),
          calendarViewSel=document.getElementById('calendarView'),
          yearView=document.getElementById('yearView'),
          weekView=document.getElementById('weekView'),
          yearGrid=document.getElementById('yearGrid'),
          yearTitle=document.getElementById('yearTitle'),
          prevYearBtn=document.getElementById('prevYear'),
          nextYearBtn=document.getElementById('nextYear'),
          prevWeekBtn=document.getElementById("prevWeek"),
          nextWeekBtn=document.getElementById("nextWeek"),
          weekTitle=document.getElementById("weekTitle");
    let activeDayDetail=null;
    const DOW=['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
    let currentYM={y:new Date().getFullYear(),m:new Date().getMonth()};
    let currentYear=currentYM.y;

    function renderMonth(){
      dowRow.innerHTML=DOW.map(d=>`<div class="dow">${d}</div>`).join('');
      const y=currentYM.y,m=currentYM.m;monthTitle.textContent=fmtDateLabel(new Date(y,m,1));
      const lastDate=new Date(y,m+1,0).getDate();const totals={};let monthMax=0;
      for(let d=1;d<=lastDate;d++){const key=`${y}-${pad(m+1)}-${pad(d)}`;const sum=entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);totals[key]=sum;monthMax=Math.max(monthMax,sum);}
      const firstDow=(new Date(y,m,1).getDay()+6)%7;const blanks=Array.from({length:firstDow},()=>'<div></div>').join('');
      monthGrid.innerHTML=blanks+Array.from({length:lastDate},(_,i)=>{
        const d=i+1,key=`${y}-${pad(m+1)}-${pad(d)}`,sum=totals[key]||0;
        const level=sum===0?0:Math.min(4,Math.ceil((sum/(monthMax||1))*4));const isToday=key===todayStr();
        return `<div class="day lvl${level} ${isToday?'today':''}" data-date="${key}"><div class="num">${d}</div><div class="mins">${sum?fmt(sum)+'m':''}</div></div>`;
      }).join('');
      dayDetails.innerHTML='';
      if(activeDayDetail) renderDayDetails(activeDayDetail);
    }

    function renderDayDetails(d){
      activeDayDetail=d;
      const list=entries.filter(x=>x.date===d).sort((a,b)=>b.createdAt-a.createdAt),total=list.reduce((a,b)=>a+b.minutes,0);
      dayDetails.innerHTML=
        `<div class="day-detail-wrap">
          <div class="day-detail-title">${d}</div>
          <div class="day-detail-total">åˆè¨ˆ <strong>${fmt(total/60,1)}</strong>h (${fmt(total)}m)</div>
          <div class="day-detail-list">
            ${list.length?list.map(e=>
              `<div class="rec-row">
                <span class="chip muted">${e.category}</span>
                <span style="font-size:13px;color:var(--muted)">${fmt(e.minutes)}m${(e.startTime&&e.endTime)?`ï¼ˆ${e.startTime}ï½${e.endTime}ï¼‰`:''}</span>
                <button class="del-btn" data-del="${e.id}">Ã—</button>
              </div>`
            ).join(''):`<div class="muted" style="padding:10px 0 0 4px;">è¨˜éŒ²ãªã—</div>`}
          </div>
        </div>`;
    }

    monthGrid.addEventListener('click',e=>{
      const d=e.target.closest('.day')?.dataset?.date;if(!d)return;
      document.getElementById('date').value = d;
      renderDayDetails(d);
    });

    dayDetails.addEventListener('click',e=>{
      const id=e.target?.dataset?.del; if(!id) return;
      entries = entries.filter(x => String(x.id) !== String(id));
      save(KEYS.entries, entries);
      toast('å‰Šé™¤ã—ã¾ã—ãŸ');
      renderSummary(); renderWeek(); renderMonth(); renderYear(); renderGoal(); renderActiveGoals(); renderGoalHistory();
      setCalendarView(calendarViewSel.value);
      if(activeDayDetail) renderDayDetails(activeDayDetail);
    });

    prevMonthBtn.addEventListener('click',()=>{if(currentYM.m===0){currentYM.y--;currentYM.m=11;}else currentYM.m--;renderMonth();});
    nextMonthBtn.addEventListener('click',()=>{if(currentYM.m===11){currentYM.y++;currentYM.m=0;}else currentYM.m++;renderMonth();});

    function renderMiniMonth(y,m){
      const lastDate=new Date(y,m+1,0).getDate();
      const totals={};let monthMax=0;
      for(let d=1;d<=lastDate;d++){
        const key=`${y}-${pad(m+1)}-${pad(d)}`;
        const sum=entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);
        totals[key]=sum;monthMax=Math.max(monthMax,sum);
      }
      const firstDow=(new Date(y,m,1).getDay()+6)%7;
      const blanks=Array.from({length:firstDow},()=>'<div class="mini-day"></div>').join('');
      const days=Array.from({length:lastDate},(_,i)=>{
        const d=i+1,key=`${y}-${pad(m+1)}-${pad(d)}`;
        const sum=totals[key]||0;
        const level=sum===0?0:Math.min(4,Math.ceil((sum/(monthMax||1))*4));
        const today=key===todayStr()? 'today' : '';
        return `<div class="mini-day lvl${level} ${today}">${d}</div>`;
      }).join('');
      return `<div class="mini-month" data-y="${y}" data-m="${m}"><div class="mini-month-name">${m+1}æœˆ</div><div class="mini-month-grid">${blanks+days}</div></div>`;
    }

    function renderYear(){yearTitle.textContent=currentYear+'å¹´';yearGrid.innerHTML=Array.from({length:12},(_,i)=>renderMiniMonth(currentYear,i)).join('');}

    function setCalendarView(view){
      calendarViewSel.value=view;
      if(view==='year'){
        yearView.style.display='block';weekView.style.display='none';dowRow.style.display='none';monthGrid.style.display='none';
        monthGrid.after(dayDetails);dayDetails.style.display='none';
        prevMonthBtn.style.display='none';nextMonthBtn.style.display='none';monthTitle.style.display='none';
        prevYearBtn.style.display='';nextYearBtn.style.display='';yearTitle.style.display='';
        currentYear=currentYM.y;prevWeekBtn.style.display="none";nextWeekBtn.style.display="none";weekTitle.style.display="none";
        renderYear();
      } else if(view==='week') {
        yearView.style.display="none";weekView.style.display="block";renderWeek();weekView.after(dayDetails);
        dowRow.style.display="none";monthGrid.style.display="none";
        dayDetails.style.display = activeDayDetail ? '' : 'none';
        prevMonthBtn.style.display="none";nextMonthBtn.style.display="none";monthTitle.style.display="none";
        prevYearBtn.style.display="none";nextYearBtn.style.display="none";yearTitle.style.display="none";
        prevWeekBtn.style.display="";nextWeekBtn.style.display="";weekTitle.style.display="";
      } else {
        yearView.style.display='none';weekView.style.display='none';
        dowRow.style.display='grid';monthGrid.style.display='grid';
        monthGrid.after(dayDetails);dayDetails.style.display='';
        prevMonthBtn.style.display='';nextMonthBtn.style.display='';monthTitle.style.display='';
        prevYearBtn.style.display='none';nextYearBtn.style.display='none';yearTitle.style.display='none';
        prevWeekBtn.style.display="none";nextWeekBtn.style.display="none";weekTitle.style.display="none";
      }
    }

    calendarViewSel.addEventListener('change',e=>{setCalendarView(e.target.value);});
    prevYearBtn.addEventListener('click',()=>{currentYear--;renderYear();});
    nextYearBtn.addEventListener('click',()=>{currentYear++;renderYear();});
    prevWeekBtn.addEventListener("click",()=>{currentWeekStart.setDate(currentWeekStart.getDate()-7);dayDetails.style.display='none';renderWeek();});
    nextWeekBtn.addEventListener("click",()=>{currentWeekStart.setDate(currentWeekStart.getDate()+7);dayDetails.style.display='none';renderWeek();});

    // é€±ãƒ“ãƒ¥ãƒ¼ click
    weekView.addEventListener('click',e=>{
      const t=e.target.closest('.cell, .week-date'); if(!t) return;
      const d=t.dataset.date; if(!d) return;
      document.getElementById('date').value = d;
      dayDetails.style.display=''; renderDayDetails(d);
    });

    yearGrid.addEventListener('click',e=>{
      const t=e.target.closest('.mini-month'); if(!t)return;
      const y=parseInt(t.dataset.y),m=parseInt(t.dataset.m);
      currentYM={y,m}; setCalendarView('month'); renderMonth();
    });

    // æœˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
    const monthModal=document.getElementById('monthModal');
    const monthTitleEl=document.getElementById('monthTitle');
    monthTitleEl.addEventListener('click',()=>{showMonthModal(currentYM.y,currentYM.m);});
    function showMonthModal(selectedY,selectedM){
      const y0=new Date().getFullYear();
      let yRange=[]; for(let y=y0-5;y<=y0+1;y++) yRange.push(y);
      let yearSel=document.getElementById('selectYear'),monthSel=document.getElementById('selectMonth');
      yearSel.innerHTML=yRange.map(y=>`<option value="${y}">${y}å¹´</option>`).join(''); yearSel.value=selectedY;
      monthSel.innerHTML=Array.from({length:12},(_,i)=>`<option value="${i}">${i+1}æœˆ</option>`).join(''); monthSel.value=selectedM;
      monthModal.style.display='flex';
    }
    document.getElementById('closeMonthModal').onclick=()=>{monthModal.style.display='none';};
    document.getElementById('gotoMonthBtn').onclick=()=>{
      const y=parseInt(document.getElementById('selectYear').value);
      const m=parseInt(document.getElementById('selectMonth').value);
      currentYM={y,m}; monthModal.style.display='none'; renderMonth();
    };

    // ----- ç›®æ¨™ç®¡ç†
    const goalForm=document.getElementById('goalForm'),
          goalStart=document.getElementById('goalStart'),
          goalEnd=document.getElementById('goalEnd'),
          goalHours=document.getElementById('goalHours'),
          goalDeleteBtn=document.getElementById('goalDeleteBtn'),
          goalHistory=document.getElementById('goalHistory'),
          activeGoalList=document.getElementById('activeGoalList');

    function goalStats(g){
      const s=parseDateStr(g.start),e=parseDateStr(g.end);
      const accum=entries.filter(x=>{
        const d=parseDateStr(x.date);
        if(d<s||d>e) return false;
        if(g.category && g.category!=='all' && x.category!==g.category) return false;
        return true;
      }).reduce((a,b)=>a+b.minutes,0);
      const target=g.targetMin;
      const pct=Math.min(100,Math.round((accum/Math.max(1,target))*100));
      return {accum,target,pct};
    }
    function renderGoal(){
      const g = latestGoal();
      if(g){goalStart.value=g.start;goalEnd.value=g.end;goalHours.value=Math.round(g.targetMin/60);goalCatSel.value=g.category||'all';}
      else {goalStart.value='';goalEnd.value='';goalHours.value='';goalCatSel.value='all';}
    }
    function renderActiveGoals(){
      const acts=activeGoals();
      if(!acts.length){activeGoalList.innerHTML='<div class="muted">ç¾åœ¨ã®ç›®æ¨™ãªã—</div>';return;}
      activeGoalList.innerHTML='<h3 style="margin:8px 0 6px 4px;">ç¾åœ¨ã®ç›®æ¨™</h3>'+
        acts.map(g=>{const idx=goals.indexOf(g);const s=goalStats(g);return `<div class="goal-hist-item"><div class="goal-hist-period">${g.start}ã€œ${g.end} [${g.category&&g.category!=='all'?g.category:'å…¨ã¦'}]</div><div class="goal-hist-kpis"><span class="gh-kpi">ç´¯è¨ˆ: <b>${fmt(s.accum/60,1)}h</b></span><span class="gh-kpi">ç›®æ¨™: <b>${fmt(g.targetMin/60,1)}h</b></span><span class="gh-kpi">é”æˆç‡: <b>${fmt(s.pct)}%</b></span></div><button class="goal-hist-del-btn" data-goaldel="${idx}">Ã—</button></div>`;}).join('');
    }
    function renderGoalHistory(){
      const past=pastGoals();
      if(!past.length){goalHistory.innerHTML='<div class="muted">éå»ã®ç›®æ¨™ãªã—</div>';return;}
      goalHistory.innerHTML='<h3 style="margin:8px 0 6px 4px;">éå»ã®ç›®æ¨™</h3>'+
        past.slice().reverse().map(g=>{const idx=goals.indexOf(g);const stats=goalStats(g);return `<div class="goal-hist-item">
            <div class="goal-hist-period">${g.start}ã€œ${g.end} [${g.category&&g.category!=='all'?g.category:'å…¨ã¦'}]</div>
            <div class="goal-hist-kpis">
              <span class="gh-kpi">ç´¯è¨ˆ: <b>${fmt(stats.accum/60,1)}h</b></span>
              <span class="gh-kpi">ç›®æ¨™: <b>${fmt(g.targetMin/60,1)}h</b></span>
              <span class="gh-kpi">é”æˆç‡: <b>${fmt(stats.pct)}%</b></span>
            </div>
            <button class="goal-hist-del-btn" data-goaldel="${idx}">Ã—</button>
          </div>`;}).join('');
    }
    document.getElementById('tab-goal').addEventListener('click',e=>{
      const idx=e.target?.dataset?.goaldel;
      if(idx!==undefined){
        goals.splice(idx,1);
        save(KEYS.goals,goals);
        renderGoalHistory();renderActiveGoals();renderSummary();renderWeek();
        toast('å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    });

    goalForm.addEventListener('submit',e=>{
      e.preventDefault();
      const start=goalStart.value,end=goalEnd.value,hours=Number(goalHours.value||0),cat=goalCatSel.value||'all';
      if(!start||!end||!hours)return;
      goals.push({start,end,targetMin:hours*60,category:cat});
      save(KEYS.goals,goals);toast('ä¿å­˜');
      const acts=activeGoals();
      if(acts.length) summaryGoalIndex=acts.length-1;
      renderGoal();renderActiveGoals();renderGoalHistory();renderSummary();renderWeek();
    });
    goalDeleteBtn.addEventListener('click',()=>{
      if(!goals.length) return;
      if(!confirm('æœ€æ–°ã®ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
      goals.pop();
      save(KEYS.goals,goals);
      renderGoal();renderActiveGoals();renderGoalHistory();renderSummary();renderWeek();
    });

    // ----- ã‚«ãƒ†ã‚´ãƒªç®¡ç†
    const newCat=document.getElementById('newCat'),addCatBtn=document.getElementById('addCat'),catList=document.getElementById('catList'),resetData=document.getElementById('resetData');
    function renderCats(){
      catList.innerHTML=categories.map((c,i)=>
        `<div class="cat-list-row">
          <span class="cat-chip" data-edit="${i}">${c}</span>
          <button class="m-item cat-btn" data-up="${i}">â†‘</button>
          <button class="m-item cat-btn" data-down="${i}">â†“</button>
          <button class="m-item cat-btn" data-del="${i}">å‰Šé™¤</button>
        </div>`
      ).join('')||`<div class="muted">ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
    }
    addCatBtn.addEventListener('click',()=>{
      const name=(newCat.value||'').trim();if(!name)return;if(categories.includes(name)){toast('æ—¢ã«å­˜åœ¨ã—ã¾ã™');return;}
      categories.push(name);save(KEYS.cats,categories);newCat.value='';renderCategorySelect();renderCats();toast('è¿½åŠ ã—ã¾ã—ãŸ');
    });
    catList.addEventListener('click',e=>{
      const edit=e.target?.dataset?.edit;
      if(edit!==undefined){
        const idx=Number(edit),oldName=categories[idx];
        const name=prompt('ã‚«ãƒ†ã‚´ãƒªåã‚’ç·¨é›†',oldName);
        if(!name) return;
        const trimmed=name.trim();
        if(!trimmed||trimmed===oldName) return;
        if(categories.includes(trimmed)){toast('æ—¢ã«å­˜åœ¨ã—ã¾ã™');return;}
        categories[idx]=trimmed;
        entries.forEach(r=>{if(r.category===oldName) r.category=trimmed;});
        goals.forEach(g=>{if(g.category===oldName) g.category=trimmed;});
        save(KEYS.entries,entries);save(KEYS.cats,categories);save(KEYS.goals,goals);
        renderAll();toast('æ›´æ–°ã—ã¾ã—ãŸ');return;
      }
      const i=e.target?.dataset?.del;
      if(i!==undefined){
        const name=categories[i],used=entries.some(x=>x.category===name)||goals.some(g=>g.category===name);
        if(used){alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªã®è¨˜éŒ²ã¾ãŸã¯ç›®æ¨™ãŒå­˜åœ¨ã—ã¾ã™ã€‚å…ˆã«è¨˜éŒ²/ç›®æ¨™ã‚’å¤‰æ›´ãƒ»å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');return;}
        categories.splice(i,1);save(KEYS.cats,categories);renderCategorySelect();renderCats();toast('å‰Šé™¤ã—ã¾ã—ãŸ');return;}
      const up=e.target?.dataset?.up,down=e.target?.dataset?.down;
      if(up!==undefined){const idx=Number(up);if(idx>0){[categories[idx-1],categories[idx]]=[categories[idx],categories[idx-1]];save(KEYS.cats,categories);renderCategorySelect();renderCats();}}
      if(down!==undefined){const idx=Number(down);if(idx<categories.length-1){[categories[idx+1],categories[idx]]=[categories[idx],categories[idx+1]];save(KEYS.cats,categories);renderCategorySelect();renderCats();}}
    });
    resetData.addEventListener('click',()=>{
      if(!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆè¨˜éŒ²ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ç›®æ¨™ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
      localStorage.removeItem(KEYS.entries);localStorage.removeItem(KEYS.cats);localStorage.removeItem(KEYS.goals);
      entries=[];categories=['IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°','å˜èª','ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°','ãƒªã‚¹ãƒ‹ãƒ³ã‚°','æ–‡æ³•','ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°'];goals=[];
      save(KEYS.cats,categories);renderAll();toast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    });

    // ----- ã¾ã¨ã‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderAll(){
      renderCategorySelect();renderSummary();renderWeek();renderMonth();renderYear();
      renderGoal();renderActiveGoals();renderGoalHistory();renderCats();
      setCalendarView(calendarViewSel.value);
    }
    function init(){
      const today = todayStr();
      document.getElementById('date').value = today;
      estimateTimes();
      renderAll();
      renderDayDetails(today);
    }
    init();
  })();
  </script>
</body>
</html>
