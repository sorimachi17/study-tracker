<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>å‹‰å¼·è¨˜éŒ²ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</title>
<style>
  :root{
    --bg: #0f1115;
    --card: #171a21;
    --text: #dfe6ee;
    --muted: #98a2b3;
    --accent: #4ea46e;
    --accent-2:#2c7a4a;
    --danger:#f25f5c;

    /* GitHubé¢¨ æ¿ƒæ·¡ */
    --lvl0:#2a2e36;      /* 0åˆ† */
    --lvl1:#284e32;      /* å°‘ */
    --lvl2:#2f6e3e;      /* ä¸­ */
    --lvl3:#2f8e4a;      /* å¤š */
    --lvl4:#31a65a;      /* ç‰¹å¤š */
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f7f8fb;
      --card: #ffffff;
      --text:#111;
      --muted:#667085;
      --accent:#2ea043;
      --accent-2:#1f7a32;
      --lvl0:#ebedf0;
      --lvl1:#c6e48b;
      --lvl2:#7bc96f;
      --lvl3:#239a3b;
      --lvl4:#196127;
    }
  }

  *{box-sizing:border-box}
  html{ -webkit-text-size-adjust:100%; scroll-behavior:smooth; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:var(--bg);
    line-height:1.5;
    overscroll-behavior-y: contain;
  }
  header{
    position:sticky; top:0; z-index:5;
    background:var(--bg);
    padding:12px 12px 8px;
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  h1{margin:0; font-size:18px}
  .sub{color:var(--muted); font-size:12px; display:none } /* ä¸è¦è¡¨ç¤ºã‚’éè¡¨ç¤º */

  .tabs{
    display:flex; gap:8px; margin-top:8px; overflow:auto; padding-bottom:4px;
  }
  .tab-btn{
    white-space:nowrap;
    border:1px solid rgba(255,255,255,.12);
    background:var(--card);
    color:var(--text);
    padding:10px 14px; border-radius:999px; font-size:16px; /* 16pxä»¥ä¸Šã§iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    touch-action:manipulation; outline:none;
  }
  .tab-btn:focus{outline:none}
  .tab-btn.active{border-color:var(--accent); box-shadow:0 0 0 2px rgba(78,164,110,.2) inset}
  main{padding:12px; max-width:980px; margin:0 auto}
  section{
    background:var(--card);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px; padding:12px; margin-bottom:12px;
    scroll-margin-top: 72px; /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã®ä½™ç™½ */
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  @media (max-width:640px){ .row{grid-template-columns:1fr} }

  label{font-size:12px; color:var(--muted)}
  input, select, button, textarea{
    width:100%; padding:12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.12);
    background:#0e1016; color:var(--text); font-size:16px; /* 16pxä»¥ä¸Šã§iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    outline:none;
  }
  @media (prefers-color-scheme: light){
    input, select, button, textarea{background:#fff; color:#111; border-color:#e5e7eb}
  }
  button.primary{background:var(--accent); color:white; border:none; font-weight:600}
  button.secondary{background:transparent}
  .btn-sm{padding:6px 8px; font-size:12px} /* å°å‹ãƒœã‚¿ãƒ³ */
  .inline{display:flex; gap:8px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#10131a; border:1px solid rgba(255,255,255,.08); font-size:12px}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .hint{font-size:12px; color:var(--muted)}
  .danger{color:var(--danger)}

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆï¼‰ */
  .calendar-head{
    display:flex; align-items:center; gap:8px; margin-bottom:8px
  }
  .calendar-grid{
    display:grid; gap:4px;
    grid-template-columns: repeat(7, 1fr);
  }
  .dow{font-size:12px; color:var(--muted); text-align:center}
  .day{
    aspect-ratio:1/1; border-radius:6px; padding:4px; position:relative;
    display:flex; flex-direction:column; justify-content:space-between;
    background:var(--lvl0); cursor:pointer;
  }
  .day .num{font-size:12px; opacity:.9}
  .day .mins{font-size:11px; text-align:right; opacity:.95}
  .lvl0{background:var(--lvl0)}
  .lvl1{background:var(--lvl1)}
  .lvl2{background:var(--lvl2)}
  .lvl3{background:var(--lvl3)}
  .lvl4{background:var(--lvl4)}
  .day.today{outline:2px solid var(--accent); outline-offset:0}

  /* é€±ãƒãƒ¼ */
  .bars{display:flex; gap:8px; align-items:flex-end; height:180px; padding:8px 4px; border-radius:10px; background:#0e1118; border:1px solid rgba(255,255,255,.06)}
  @media (prefers-color-scheme: light){ .bars{background:#fff; border-color:#e5e7eb} }
  .bar{flex:1; display:flex; flex-direction:column; align-items:center; gap:6px}
  .bar .val{font-size:11px}
  .bar .col{width:100%; border-radius:6px; background:var(--accent); min-height:2px}
  .bar label{font-size:11px; text-align:center}

  .list{display:flex; flex-direction:column; gap:8px}
  .item{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:10px; background:#0d0f15}
  @media (prefers-color-scheme: light){ .item{background:#fff; border-color:#e5e7eb} }

  /* ç›®æ¨™ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ */
  .progress-wrap{background:#0e1118; border:1px solid rgba(255,255,255,.06); padding:10px; border-radius:10px}
  @media (prefers-color-scheme: light){ .progress-wrap{background:#fff; border-color:#e5e7eb} }
  .progress{height:14px; background:#2a2e36; border-radius:999px; overflow:hidden}
  .progress > div{height:100%; background:var(--accent); width:0%}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px}
  @media (max-width:560px){ .kpis{grid-template-columns:1fr 1fr} }

  .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#11161c; color:#dfe6ee; padding:10px 14px; border:1px solid rgba(255,255,255,.08); border-radius:999px; opacity:0; pointer-events:none; transition:.25s}
  .toast.show{opacity:1}

  .footer-note{font-size:11px; color:var(--muted); text-align:center; margin:16px 0 32px}
</style>
</head>
<body>
  <header>
    <h1>ğŸ“˜ å‹‰å¼·è¨˜éŒ²</h1>
    <!-- ã¾ã•ã®è¦æœ›ã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®æ³¨æ„æ›¸ãã‚’éè¡¨ç¤ºåŒ– -->
    <div class="tabs" id="tabs">
      <button class="tab-btn" data-tab="input">è¨˜éŒ²</button>
      <button class="tab-btn active" data-tab="month">æœˆ</button>
      <button class="tab-btn" data-tab="week">é€±</button>
      <!-- æ—¥ã‚¿ãƒ–ã¯ä¸è¦ã®ãŸã‚å‰Šé™¤ -->
      <button class="tab-btn" data-tab="goal">ç›®æ¨™</button>
      <button class="tab-btn" data-tab="cats">ã‚«ãƒ†ã‚´ãƒª</button>
      <button class="tab-btn right" id="exportBtn" title="JSONã§æ›¸ãå‡ºã—">ğŸ“¤</button>
      <button class="tab-btn" id="importBtn" title="JSONã‚’èª­ã¿è¾¼ã¿">ğŸ“¥</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>
  </header>

  <main>
    <!-- æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ -->
    <section id="tab-month">
      <div class="calendar-head">
        <button id="prevMonth" class="tab-btn btn-sm">â†</button>
        <div id="monthTitle" style="font-weight:700"></div>
        <button id="nextMonth" class="tab-btn btn-sm">â†’</button>
        <button id="thisMonth" class="tab-btn btn-sm">ä»Šæœˆ</button>
        <!-- å‡¡ä¾‹ã¯ä¸è¦ã®ãŸã‚å‰Šé™¤ -->
      </div>
      <div class="calendar-grid" id="dowRow"></div>
      <div class="calendar-grid" id="monthGrid"></div>

      <div id="dayDetails" style="margin-top:10px"></div>
    </section>

    <!-- å…¥åŠ›ï¼ˆã€Œæœˆã€ç”»é¢ã®ä¸‹ã«é…ç½®ã€‚è¨˜éŒ²ã‚¿ãƒƒãƒ—ã§ã“ã“ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
    <section id="tab-input">
      <form id="entryForm">
        <div class="row">
          <div>
            <label>æ—¥ä»˜</label>
            <input type="date" id="date" required>
          </div>
          <div>
            <label>æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
            <!-- æ•°å­—ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é¿ã‘ãŸã„è¦æœ›ã«ã‚ˆã‚Š text ã«å¤‰æ›´ -->
            <input type="text" id="minutes" placeholder="ä¾‹: 45" required>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="category"></select>
          </div>
          <div class="inline" style="align-items:end">
            <!-- æ¨å®šUIã¯è¡¨ç¤ºã›ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ¨å®š â†’ ä¸‹ã®æ™‚åˆ»å…¥åŠ›ã«åæ˜ ã€‚æ‰‹å‹•ç·¨é›†å¯ -->
            <div class="row" style="width:100%">
              <div>
                <label>é–‹å§‹æ™‚åˆ»</label>
                <input type="time" id="startTime">
              </div>
              <div>
                <label>çµ‚äº†æ™‚åˆ»</label>
                <input type="time" id="endTime">
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div><button type="submit" class="primary">è¨˜éŒ²ã™ã‚‹</button></div>
          <!-- ã€Œä»Šæ—¥ã«ã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã¯ä¸è¦ã®ãŸã‚å‰Šé™¤ -->
        </div>
      </form>

      <!-- è‡ªå‹•æ›´æ–°ã®æ³¨æ„æ›¸ãã¯ä¸è¦ã®ãŸã‚å‰Šé™¤ -->

      <div style="margin-top:12px">
        <strong>ç›´è¿‘ã®è¨˜éŒ²</strong>
        <div class="list" id="recentList"></div>
      </div>
    </section>

    <!-- é€±é›†è¨ˆ -->
    <section id="tab-week" style="display:none">
      <div class="inline" style="justify-content:space-between">
        <div><strong>ç›´è¿‘8é€±é–“ã®åˆè¨ˆï¼ˆé€±ã¯æœˆæ›œé–‹å§‹ï¼‰</strong></div>
        <div class="hint" id="weekTotalHint"></div>
      </div>
      <div class="bars" id="weekBars" style="margin-top:8px"></div>
      <div class="list" id="weekTable" style="margin-top:8px"></div>
    </section>

    <!-- ç›®æ¨™ -->
    <section id="tab-goal" style="display:none">
      <form id="goalForm">
        <div class="row">
          <div>
            <label>é–‹å§‹æ—¥</label>
            <input type="date" id="goalStart" required>
          </div>
          <div>
            <label>çµ‚äº†æ—¥</label>
            <input type="date" id="goalEnd" required>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>ç›®æ¨™æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
            <input type="number" id="goalHours" min="1" placeholder="ä¾‹: 100" required>
          </div>
          <div style="align-self:end" class="inline">
            <button class="primary" type="submit">ç›®æ¨™ã‚’ä¿å­˜</button>
            <button class="tab-btn btn-sm danger" id="deleteGoal" type="button" title="ç›®æ¨™ã‚’å‰Šé™¤">å‰Šé™¤</button>
          </div>
        </div>
      </form>

      <div class="progress-wrap" style="margin-top:12px">
        <div class="inline" style="justify-content:space-between">
          <div><strong>ç›®æ¨™é”æˆç‡</strong></div>
          <div class="hint" id="goalRangeHint"></div>
        </div>
        <div class="progress" style="margin-top:8px">
          <div id="goalBar"></div>
        </div>
        <div class="kpis">
          <div class="item">
            <div>ç´¯è¨ˆ</div>
            <div id="goalAccum" style="font-weight:700"></div>
          </div>
          <div class="item">
            <div>ç›®æ¨™</div>
            <div id="goalTarget" style="font-weight:700"></div>
          </div>
          <div class="item">
            <div>é”æˆç‡</div>
            <div id="goalPct" style="font-weight:700"></div>
          </div>
        </div>
        <div class="hint" id="goalDaysLeft" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
    <section id="tab-cats" style="display:none">
      <div class="row">
        <div>
          <label>æ–°è¦ã‚«ãƒ†ã‚´ãƒªå</label>
          <input type="text" id="newCat" placeholder="ä¾‹: IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°">
        </div>
        <div style="align-self:end">
          <button id="addCat" class="primary" type="button">è¿½åŠ </button>
        </div>
      </div>
      <div style="margin-top:8px" id="catList" class="list"></div>

      <div class="inline" style="margin-top:12px; gap:8px">
        <button id="resetData" class="tab-btn danger" type="button">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        <!-- ä¸‹ã®æ³¨æ„æ›¸ãã¯ä¸è¦ã®ãŸã‚å‰Šé™¤ -->
      </div>
    </section>

    <div class="footer-note">v1.1 / ã™ã¹ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‹•ä½œ</div>
  </main>

  <div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
(function(){
  const KEYS = {
    entries: 'studyEntries_v1',
    cats: 'studyCategories_v1',
    goal: 'studyGoal_v1'
  };

  /*** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ***/
  const pad = n => String(n).padStart(2,'0');
  const todayStr = () => {
    const d = new Date(); return [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate())].join('-');
  };
  const fmtDateLabel = (d) => \`\${d.getFullYear()}å¹´\${d.getMonth()+1}æœˆ\`;
  const parseDateStr = (s) => { // safe local midnight
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  };
  const dateToStr = (d) => \`\${d.getFullYear()}-\${pad(d.getMonth()+1)}-\${pad(d.getDate())}\`;
  const mondayOf = (d) => {
    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const w = (t.getDay() + 6) % 7; // Mon=0
    t.setDate(t.getDate() - w);
    return t;
  };
  const addDays = (d, n) => { const t = new Date(d); t.setDate(t.getDate()+n); return t; };

  const toast = (msg='ä¿å­˜ã—ã¾ã—ãŸ')=>{
    const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1200);
  };

  /*** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ***/
  const load = (k, fallback) => {
    try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fallback; }
    catch(e){ return fallback; }
  };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  /*** åˆæœŸãƒ‡ãƒ¼ã‚¿ ***/
  let entries = load(KEYS.entries, []);
  let categories = load(KEYS.cats, [
    'IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°','å˜èª','ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°','ãƒªã‚¹ãƒ‹ãƒ³ã‚°','æ–‡æ³•','ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°'
  ]);
  let goal = load(KEYS.goal, null);

  /*** DOM å‚ç…§ ***/
  const tabsEl = document.getElementById('tabs');
  const tabBtns = [...tabsEl.querySelectorAll('.tab-btn[data-tab]')];
  const sections = {
    input: document.getElementById('tab-input'),
    month: document.getElementById('tab-month'),
    week:  document.getElementById('tab-week'),
    goal:  document.getElementById('tab-goal'),
    cats:  document.getElementById('tab-cats'),
  };

  /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
  const form = document.getElementById('entryForm');
  const dateEl = document.getElementById('date');
  const minEl = document.getElementById('minutes');
  const catSel = document.getElementById('category');
  const startTimeEl = document.getElementById('startTime');
  const endTimeEl = document.getElementById('endTime');
  let manualTimes = false; // æ‰‹å‹•ç·¨é›†æ¸ˆã¿ãªã‚‰æ¨å®šã§ä¸Šæ›¸ãã—ãªã„
  const recentList = document.getElementById('recentList');

  /* æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  const dowRow = document.getElementById('dowRow');
  const monthGrid = document.getElementById('monthGrid');
  const monthTitle = document.getElementById('monthTitle');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  const thisMonthBtn = document.getElementById('thisMonth');
  const dayDetails = document.getElementById('dayDetails');
  const DOW = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥']

  /* é€± */
  const weekBars = document.getElementById('weekBars');
  const weekTable = document.getElementById('weekTable');
  const weekTotalHint = document.getElementById('weekTotalHint');

  /* ç›®æ¨™ */
  const goalForm = document.getElementById('goalForm');
  const goalStart = document.getElementById('goalStart');
  const goalEnd = document.getElementById('goalEnd');
  const goalHours = document.getElementById('goalHours');
  const deleteGoalBtn = document.getElementById('deleteGoal');
  const goalBar = document.getElementById('goalBar');
  const goalAccum = document.getElementById('goalAccum');
  const goalTarget = document.getElementById('goalTarget');
  const goalPct = document.getElementById('goalPct');
  const goalRangeHint = document.getElementById('goalRangeHint');
  const goalDaysLeft = document.getElementById('goalDaysLeft');

  /* ã‚«ãƒ†ã‚´ãƒª */
  const newCat = document.getElementById('newCat');
  const addCatBtn = document.getElementById('addCat');
  const catList = document.getElementById('catList');
  const resetData = document.getElementById('resetData');

  /* å–è¾¼/æ›¸å‡ºã— */
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');

  /*** ã‚¿ãƒ– ***/
  function setTab(name){
    for(const btn of tabBtns){
      // è¨˜éŒ²ã¯æ“¬ä¼¼ã‚¿ãƒ–ãªã®ã§activeã¯æœˆã«åˆã‚ã›ã‚‹
      const isActive = (name==='month' && btn.dataset.tab==='month') ||
                       (name!=='month' && btn.dataset.tab===name);
      btn.classList.toggle('active', isActive);
    }
    // ã¾ãšå…¨éƒ¨éš ã™
    Object.values(sections).forEach(sec => sec.style.display = 'none');
    // æœˆã‚¿ãƒ–ã®ã¨ãã¯ã€Œæœˆã€ã¨ã€Œå…¥åŠ›ã€ã‚’ç¸¦ã«ä¸¦ã¹ã¦è¡¨ç¤º
    if(name==='month'){
      sections.month.style.display = 'block';
      sections.input.style.display = 'block';
      renderMonth();
    }else{
      sections[name].style.display = 'block';
      if(name==='week')  renderWeek();
      if(name==='goal')  renderGoal();
      if(name==='cats')  renderCats();
    }
  }
  tabsEl.addEventListener('click', (e)=>{
    const t = e.target.closest('.tab-btn[data-tab]'); if(!t) return;
    const name = t.dataset.tab;
    if(name==='input'){
      // è¨˜éŒ²ãƒœã‚¿ãƒ³ã¯æœˆã‚¿ãƒ–ã‚’è¡¨ç¤ºã—ã¦å…¥åŠ›ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      setTab('month');
      document.getElementById('tab-input').scrollIntoView({behavior:'smooth', block:'start'});
      return;
    }
    setTab(name);
  });

  /*** å…¥åŠ›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ***/
  function renderCategorySelect(){
    catSel.innerHTML = '';
    categories.forEach(c=>{
      const opt=document.createElement('option'); opt.value=c; opt.textContent=c; catSel.appendChild(opt);
    });
  }
  function renderRecent(){
    const last = [...entries].sort((a,b)=> b.createdAt - a.createdAt).slice(0,10);
    recentList.innerHTML = last.map(e=>{
      const timeText = (e.startTime && e.endTime) ? \`ï¼ˆ\${e.startTime}â†’\${e.endTime}ï¼‰\` : '';
      return \`<div class="item">
        <div>
          <div><strong>\${e.date}</strong> <span class="chip">\${e.category}</span></div>
          <div class="muted" style="font-size:12px">\${e.minutes} åˆ† \${timeText}</div>
        </div>
        <button class="tab-btn btn-sm danger" data-del="\${e.id}">å‰Šé™¤</button>
      </div>\`;
    }).join('') || \`<div class="hint">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>\`;
  }
  recentList.addEventListener('click', (e)=>{
    const id = e.target?.dataset?.del; if(!id) return;
    entries = entries.filter(x=>String(x.id)!==String(id));
    save(KEYS.entries, entries); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
    renderAll();
  });

  function hhmm(d){ return \`\${pad(d.getHours())}:\${pad(d.getMinutes())}\`; }

  function estimateTimes(){
    // minutes ã¨ æ—¥ä»˜ãŒä»Šæ—¥ã®å ´åˆã«ã€ç¾åœ¨æ™‚åˆ»ã‹ã‚‰é€†ç®—ã€‚æ‰‹å‹•ç·¨é›†æ¸ˆã¿ãªã‚‰ä¸Šæ›¸ãã—ãªã„ã€‚
    const minsRaw = (minEl.value || '').trim();
    const mins = parseInt(minsRaw, 10);
    if(!Number.isFinite(mins) || mins<=0) return;
    if(dateEl.value !== todayStr()) return;
    if(manualTimes) return;
    const end = new Date();
    const start = new Date(end.getTime() - mins*60000);
    startTimeEl.value = hhmm(start);
    endTimeEl.value   = hhmm(end);
  }
  minEl.addEventListener('input', estimateTimes);
  dateEl.addEventListener('change', ()=>{ manualTimes=false; estimateTimes(); });
  startTimeEl.addEventListener('input', ()=>{ manualTimes = true; });
  endTimeEl.addEventListener('input',   ()=>{ manualTimes = true; });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const minutes = parseInt((minEl.value||'').trim(), 10);
    if(!Number.isFinite(minutes) || minutes<=0) return;

    // æ¨å®šãŒæœªç¢ºå®šãªã‚‰ã“ã“ã§ä¸€åº¦ã ã‘è‡ªå‹•ç®—å‡º
    if(!manualTimes && (!startTimeEl.value || !endTimeEl.value) && dateEl.value === todayStr()){
      estimateTimes();
    }

    const rec = {
      id: Date.now().toString(36),
      date: dateEl.value || todayStr(),
      minutes,
      category: catSel.value,
      createdAt: Date.now(),
      startTime: startTimeEl.value || null,
      endTime:   endTimeEl.value   || null
    };
    entries.push(rec);
    save(KEYS.entries, entries);

    // å…¥åŠ›ã‚¯ãƒªã‚¢ï¼ˆæ™‚åˆ»ã¯ç¶™ç¶šåˆ©ç”¨ã—ãªã„ï¼‰
    minEl.value = '';
    if(dateEl.value===todayStr()){ manualTimes=false; estimateTimes(); } else { startTimeEl.value = ''; endTimeEl.value=''; manualTimes=false; }
    toast();
    renderAll();
  });

  /*** æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ***/
  let currentYM = {y: new Date().getFullYear(), m: new Date().getMonth()};
  function renderMonth(){
    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ï¼ˆMonã€œSunï¼‰
    dowRow.innerHTML = DOW.map(d=>\`<div class="dow">\${d}</div>\`).join('');

    const y = currentYM.y, m = currentYM.m;
    monthTitle.textContent = fmtDateLabel(new Date(y,m,1));

    // æœˆå†…ã®å„æ—¥ã®åˆè¨ˆ
    const lastDate = new Date(y, m+1, 0).getDate();
    const totals = {};
    let monthMax = 0;
    for(let d=1; d<=lastDate; d++){
      const key = \`\${y}-\${pad(m+1)}-\${pad(d)}\`;
      const sum = entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);
      totals[key] = sum; monthMax = Math.max(monthMax, sum);
    }
    const firstDow = (new Date(y,m,1).getDay()+6)%7; // Mon start
    const blanks = Array.from({length:firstDow}, ()=>'<div></div>').join('');

    monthGrid.innerHTML = blanks + Array.from({length:lastDate}, (_,i)=>{
      const d=i+1, key = \`\${y}-\${pad(m+1)}-\${pad(d)}\`, sum = totals[key]||0;
      const level = sum===0 ? 0 : Math.min(4, Math.ceil((sum/(monthMax||1))*4));
      const isToday = key===todayStr();
      return \`<div class="day lvl\${level} \${isToday?'today':''}" data-date="\${key}">
        <div class="num">\${d}</div>
        <div class="mins">\${sum? sum+'åˆ†':''}</div>
      </div>\`;
    }).join('');

    dayDetails.innerHTML = \`<div class="hint">æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®æ—¥ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>\`;
  }
  monthGrid.addEventListener('click', (e)=>{
    const d = e.target.closest('.day')?.dataset?.date; if(!d) return;
    const list = entries.filter(x=>x.date===d).sort((a,b)=>b.createdAt-a.createdAt);
    const total = list.reduce((a,b)=>a+b.minutes,0);
    dayDetails.innerHTML = \`
      <div class="item">
        <div><strong>\${d}</strong></div>
        <div>åˆè¨ˆ <strong>\${total}</strong> åˆ†</div>
      </div>
      \${ list.map(e=>\`
        <div class="item">
          <div>
            <div><span class="chip">\${e.category}</span></div>
            <div class="muted" style="font-size:12px">\${e.minutes} åˆ† \${e.startTime && e.endTime ? 'ï¼ˆ'+e.startTime+'â†’'+e.endTime+'ï¼‰':''}</div>
          </div>
          <button class="tab-btn btn-sm danger" data-del="\${e.id}">å‰Šé™¤</button>
        </div>
      \`).join('') || \`<div class="hint">è¨˜éŒ²ãªã—</div>\`}
    \`;
  });
  dayDetails.addEventListener('click', (e)=>{
    const id = e.target?.dataset?.del; if(!id) return;
    entries = entries.filter(x=>String(x.id)!==String(id));
    save(KEYS.entries, entries); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
    renderAll();
  });
  prevMonthBtn.addEventListener('click', ()=>{
    if(currentYM.m===0){ currentYM.y--; currentYM.m=11; } else currentYM.m--;
    renderMonth();
  });
  nextMonthBtn.addEventListener('click', ()=>{
    if(currentYM.m===11){ currentYM.y++; currentYM.m=0; } else currentYM.m++;
    renderMonth();
  });
  thisMonthBtn.addEventListener('click', ()=>{
    const d=new Date(); currentYM={y:d.getFullYear(), m:d.getMonth()}; renderMonth();
  });

  /*** é€±ãƒ“ãƒ¥ãƒ¼ ***/
  function renderWeek(){
    // ç›´è¿‘8é€±é–“ï¼ˆç¾åœ¨é€±å«ã‚€ï¼‰
    const today = new Date();
    const startThisWeek = mondayOf(today);
    const weeks = [];
    for(let i=7; i>=0; i--){
      const start = addDays(startThisWeek, -7*i);
      const end = addDays(start, 6);
      const sum = entries.filter(e=>{
        const t = parseDateStr(e.date);
        return t>=start && t<=end;
      }).reduce((a,b)=>a+b.minutes,0);
      weeks.push({start, end, sum});
    }
    const max = Math.max(...weeks.map(w=>w.sum), 1);
    weekBars.innerHTML = weeks.map(w=>{
      const h = Math.round((w.sum/max)*100);
      const label = \`\${pad(w.start.getMonth()+1)}/\${pad(w.start.getDate())}\`;
      return \`<div class="bar" title="\${label}ã€œ\${pad(w.end.getMonth()+1)}/\${pad(w.end.getDate())}ï¼š\${w.sum}åˆ†">
        <div class="val">\${w.sum}</div>
        <div class="col" style="height:\${h}%"></div>
        <label>\${label}</label>
      </div>\`;
    }).join('');

    weekTable.innerHTML = weeks.slice().reverse().map(w=>{
      return \`<div class="item">
        <div>\${w.start.getFullYear()}/\${pad(w.start.getMonth()+1)}/\${pad(w.start.getDate())} ã€œ \${pad(w.end.getMonth()+1)}/\${pad(w.end.getDate())}</div>
        <div><strong>\${w.sum}</strong> åˆ†</div>
      </div>\`;
    }).join('');

    const total8 = weeks.reduce((a,b)=>a+b.sum,0);
    weekTotalHint.textContent = \`åˆè¨ˆ: \${total8} åˆ†ï¼ˆç›´è¿‘8é€±ï¼‰\`;
  }

  /*** ç›®æ¨™ ***/
  function renderGoal(){
    if(goal){
      goalStart.value = goal.start;
      goalEnd.value   = goal.end;
      goalHours.value = Math.round(goal.targetMin/60);
    }
    const hint = goal ? \`\${goal.start}ã€œ\${goal.end}\` : 'æœªè¨­å®š';
    goalRangeHint.textContent = hint;

    let accum = 0, target = 0, pct = 0, left = '';
    if(goal){
      const s = parseDateStr(goal.start), e = parseDateStr(goal.end);
      accum = entries.filter(x=>{
        const d = parseDateStr(x.date);
        return d>=s && d<=e;
      }).reduce((a,b)=>a+b.minutes,0);
      target = goal.targetMin;
      pct = Math.min(100, Math.round((accum/Math.max(1,target))*100));
      const daysLeft = Math.max(0, Math.ceil((e - new Date())/86400000));
      left = \`çµ‚äº†ã¾ã§æ®‹ã‚Š \${daysLeft} æ—¥\`;
    }
    goalBar.style.width = pct + '%';
    goalAccum.textContent = \`\${accum.toLocaleString()} åˆ†\`;
    goalTarget.textContent = target ? \`\${target.toLocaleString()} åˆ†\` : 'â€”';
    goalPct.textContent = target ? \`\${pct}%\` : 'â€”';
    goalDaysLeft.textContent = left;
  }
  goalForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const start = goalStart.value, end = goalEnd.value, hours = Number(goalHours.value||0);
    if(!start || !end || !hours) return;
    goal = {start, end, targetMin: hours*60};
    save(KEYS.goal, goal); toast('ç›®æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    renderGoal();
  });
  deleteGoalBtn.addEventListener('click', ()=>{
    if(!confirm('ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    goal = null; localStorage.removeItem(KEYS.goal); renderGoal(); toast('ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  });

  /*** ã‚«ãƒ†ã‚´ãƒªç®¡ç† ***/
  function renderCats(){
    catList.innerHTML = categories.map((c,i)=>\`
      <div class="item">
        <div>\${c}</div>
        <div class="inline">
          <button class="tab-btn btn-sm" data-up="\${i}">â†‘</button>
          <button class="tab-btn btn-sm" data-down="\${i}">â†“</button>
          <button class="tab-btn btn-sm danger" data-del="\${i}">å‰Šé™¤</button>
        </div>
      </div>
    \`).join('') || \`<div class="hint">ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>\`;
  }
  addCatBtn.addEventListener('click', ()=>{
    const name = (newCat.value||'').trim();
    if(!name) return;
    if(categories.includes(name)){ toast('æ—¢ã«å­˜åœ¨ã—ã¾ã™'); return; }
    categories.push(name); save(KEYS.cats, categories);
    newCat.value=''; renderCategorySelect(); renderCats(); toast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  });
  catList.addEventListener('click', (e)=>{
    const i = e.target?.dataset?.del;
    if(i!==undefined){
      const name = categories[i];
      const used = entries.some(x=>x.category===name);
      if(used){ alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªã®è¨˜éŒ²ãŒå­˜åœ¨ã—ã¾ã™ã€‚å…ˆã«è¨˜éŒ²ã‚’å¤‰æ›´/å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚'); return; }
      categories.splice(i,1); save(KEYS.cats, categories);
      renderCategorySelect(); renderCats(); toast('å‰Šé™¤ã—ã¾ã—ãŸ'); return;
    }
    const up = e.target?.dataset?.up, down = e.target?.dataset?.down;
    if(up!==undefined){
      const idx = Number(up); if(idx>0){
        [categories[idx-1], categories[idx]] = [categories[idx], categories[idx-1]];
        save(KEYS.cats, categories); renderCategorySelect(); renderCats();
      }
    }
    if(down!==undefined){
      const idx = Number(down); if(idx<categories.length-1){
        [categories[idx+1], categories[idx]] = [categories[idx], categories[idx+1]];
        save(KEYS.cats, categories); renderCategorySelect(); renderCats();
      }
    }
  });

  resetData.addEventListener('click', ()=>{
    if(!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆè¨˜éŒ²ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ç›®æ¨™ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    localStorage.removeItem(KEYS.entries);
    localStorage.removeItem(KEYS.cats);
    localStorage.removeItem(KEYS.goal);
    entries=[]; categories=['IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°','å˜èª','ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°','ãƒªã‚¹ãƒ‹ãƒ³ã‚°','æ–‡æ³•','ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°']; goal=null;
    save(KEYS.cats, categories);
    renderAll(); toast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
  });

  /*** JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ***/
  exportBtn.addEventListener('click', ()=>{
    const data = {entries, categories, goal, exportedAt: new Date().toISOString()};
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = \`study_backup_\${Date.now()}.json\`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  importBtn.addEventListener('click', ()=>importFile.click());
  importFile.addEventListener('change', async ()=>{
    const f = importFile.files[0]; if(!f) return;
    const text = await f.text();
    try{
      const data = JSON.parse(text);
      if(!data || !Array.isArray(data.entries)) throw new Error('ä¸æ­£ãªå½¢å¼');
      entries = data.entries; categories = data.categories || categories; goal = data.goal || null;
      save(KEYS.entries, entries); save(KEYS.cats, categories); save(KEYS.goal, goal);
      renderAll(); toast('èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    }catch(err){
      alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    }finally{
      importFile.value='';
    }
  });

  /*** ã¾ã¨ã‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ***/
  function renderAll(){
    renderCategorySelect();
    renderRecent();
    renderMonth();
    renderWeek();
    renderGoal();
  }

  /*** åˆæœŸåŒ– ***/
  function init(){
    dateEl.value = todayStr();
    setTab('month');      // åˆæœŸè¡¨ç¤ºã¯ã€Œæœˆã€
    renderAll();
  }
  init();

})();
</script>
</body>
</html>
