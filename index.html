<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
  <title>勉強記録アプリ</title>
  <style>
    :root{
      --bg: #0f1115;
      --card: #171a21;
      --text: #dfe6ee;
      --muted: #98a2b3;
      --accent: #4ea46e;
      --accent-2:#2c7a4a;
      --danger:#f25f5c;
      --chip: #232834;
      --chip-muted: #545e70;
      --chip-text: #fff;
      --lvl0:#2a2e36;
      --lvl1:#284e32;
      --lvl2:#2f6e3e;
      --lvl3:#2f8e4a;
      --lvl4:#31a65a;
      --goalhist-bg: #16191e;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --card: #ffffff;
        --text:#111;
        --muted:#667085;
        --accent:#2ea043;
        --accent-2:#1f7a32;
        --danger:#f25f5c;
        --chip: #e6f4ea;
        --chip-muted: #c2c7cf;
        --chip-text: #1a2a15;
        --lvl0:#ebedf0;
        --lvl1:#c6e48b;
        --lvl2:#7bc96f;
        --lvl3:#239a3b;
        --lvl4:#196127;
        --goalhist-bg: #f4f5f8;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
      line-height:1.5;
    }
    header{
      position:sticky;top:0;z-index:5;background:var(--bg);
      padding:12px 12px 8px;border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{margin:0;font-size:18px}
    .tabs{display:flex;gap:8px;margin-top:8px;overflow:auto;padding-bottom:4px;}
    .tab-btn{white-space:nowrap;border:1px solid rgba(255,255,255,.12);background:var(--card);color:var(--text);padding:7px 13px;border-radius:999px;font-size:13px;}
    .tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(78,164,110,.2) inset}
    main{padding:12px;max-width:980px;margin:0 auto}
    section{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-bottom:12px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0e1016;color:var(--text);font-size:15px;}
    @media (prefers-color-scheme: light){input,select,button,textarea{background:#fff;color:#111;border-color:#e5e7eb}}
    button.primary{background:var(--accent);color:white;border:none;font-weight:600}
    button.secondary{background:transparent}
    .inline{display:flex;gap:8px;align-items:center}
    .chip{
      display:inline-block;min-width:40px;text-align:center;padding:4px 10px;
      border-radius:16px;
      background:var(--chip-muted);
      color:var(--chip-text);
      font-size:13px;font-weight:500;letter-spacing:0.2px;
    }
    .chip.main{background:var(--chip);color:var(--chip-text);}
    .chip.accent{background:var(--accent);color:#fff;}
    .chip.muted{background:var(--chip-muted);color:var(--chip-text);}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    /* summary card */
    .summary-card {
      background: var(--card);
      border: 1.5px solid var(--accent);
      border-radius: 14px;
      margin-bottom: 18px;
      padding: 18px 14px 12px 14px;
      display: flex; flex-direction: column; gap: 8px;
      font-size: 15px;
    }
    .summary-kpi { font-size: 26px; font-weight: bold; }
    .summary-list { display: grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; }
    @media (max-width:600px) {.summary-list { grid-template-columns:1fr; } }
    .summary-progress-bar {
      width:100%;height:11px;border-radius:7px;
      background:var(--lvl0);margin:10px 0 4px 0;overflow:hidden;
    }
    .summary-progress-bar-inner {
      height:100%;border-radius:7px;background:var(--accent);
      transition:.25s;width:0;
    }
    .week-table {width:100%;border-collapse:collapse;font-size:13px;}
    .week-table th,.week-table td{padding:4px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left;}
    /* 共通プログレスバー */
    .progress {
      width:100%;height:10px;border-radius:8px;
      background:var(--lvl0);overflow:hidden;
    }
    .progress-inner {
      height:100%;background:var(--accent);
      border-radius:8px;transition:.2s;width:0;
    }
    /* カレンダー */
    .calendar-head{
      display:flex;align-items:center;gap:2px;margin-bottom:8px;justify-content:center;
    }
    .calendar-nav-btn{
      width:32px;height:32px;
      display:flex;align-items:center;justify-content:center;
      border-radius:50%;border:none;background:var(--lvl0);
      font-size:19px;cursor:pointer;transition:.15s;
      margin:0 3px;
    }
    .calendar-nav-btn:active {background:var(--lvl1);}
    .calendar-nav-select {
      height:32px;
      border-radius:6px;
      background:var(--lvl0);
      color:var(--text);
      border:none;
      padding:0 4px;
      font-size:14px;
      margin:0 3px;
      width:72px;
    }
    .calendar-title-btn{font-size:17px;font-weight:700;cursor:pointer;padding:3px 10px;border-radius:6px;transition:background .15s;}
    .calendar-title-btn:hover{background:var(--lvl1);}
    .calendar-grid{display:grid;gap:4px;grid-template-columns:repeat(7,1fr);}
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .day{aspect-ratio:1/1;border-radius:6px;padding:4px;position:relative;display:flex;flex-direction:column;justify-content:space-between;background:var(--lvl0);cursor:pointer;}
    .day .num{font-size:12px;opacity:.9}
    .day .mins{font-size:11px;text-align:right;opacity:.95}
    .lvl0{background:var(--lvl0)}
    .lvl1{background:var(--lvl1)}
    .lvl2{background:var(--lvl2)}
    .lvl3{background:var(--lvl3)}
    .lvl4{background:var(--lvl4)}
    .day.today{outline:2px solid var(--accent);outline-offset:0}
    /* 年間カレンダー */
    .year-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;}
    .mini-month{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:4px;cursor:pointer;}
    .mini-month-name{text-align:center;font-size:12px;color:var(--muted);margin-bottom:2px;}
    .mini-month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
    .mini-day{aspect-ratio:1/1;font-size:9px;border-radius:2px;display:flex;align-items:center;justify-content:center;}
    .mini-day.today{outline:1px solid var(--accent);}
    .day-detail-wrap {
      background:var(--card);
      border-radius:11px;
      margin-bottom:10px;
      box-shadow:0 2px 10px rgba(30,40,45,0.06);
      border:1.5px solid var(--lvl0);
      padding:18px 15px 8px 15px;
      max-width:440px;
    }
    .day-detail-title {
      font-size:19px;font-weight:600;margin-bottom:2px;letter-spacing:0.5px;
    }
    .day-detail-total {
      font-size:14px;color:var(--muted);margin-bottom:10px;
    }
    .day-detail-list .rec-row {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--lvl0);
    border-radius: 8px;
    padding: 6px 8px;
    margin-bottom: 6px;
    border: 1px solid rgba(255,255,255,.07);
    }
    .day-detail-list .rec-row .chip {
    min-width: 56px;
    max-width: 110px;
    white-space: nowrap;
    padding: 3px 11px;
    font-size: 13px;
    margin-right: 4px;
    border-radius: 12px;
    background: var(--chip-muted);
    color: var(--chip-text);
    text-align: center;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    }
    .day-detail-list .rec-row .del-btn {
    padding: 0 11px;
    min-width: 0;
    font-size: 15px;
    border-radius: 7px;
    background: var(--muted);
    color: var(--bg);
    border: none;
    margin-left: auto;
    transition: .2s;
    height: 28px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    }
    .day-detail-list .rec-row .del-btn:hover {background:var(--danger);}
    .day-detail-list .rec-row .del-btn.no-hover:hover {background:var(--muted);}
    /* --- 記録フォーム --- */
    .form-row-flex {display: flex; gap: 12px; align-items: flex-end; margin-bottom:4px;}
    @media (max-width:600px) {.form-row-flex { flex-direction:column; align-items:stretch; gap:4px;} }
    .input-block { flex:1; }
    .time-input-row {display: flex; gap: 8px; align-items: center; margin-top: 6px;}
    .time-input-row label { font-size:12px; color:var(--muted);}
    .time-fields {
      display: flex;
      gap: 8px;
      flex: 1 1 0;
      min-width: 0;
    }
    .time-fields input[type="text"] {
      flex: 1 1 0;
      min-width: 60px;
      max-width: 120px;
      text-align: center;
      padding: 10px;
      font-size: 15px;
    }
    @media (max-width:600px) {.time-fields input[type="text"]{max-width: 100%;}}
    .entry-submit-row {
      display:flex;
      justify-content:center;
      margin-top:10px;
      margin-bottom:0;
    }
    .entry-submit-row button {
      max-width:220px;width:80%;font-size:16px;padding:15px 0;border-radius:12px;
    }
    /* --- カード分割 --- */
    .flex-split {display:flex;flex-direction:row;gap:20px;}
    @media (max-width:900px) {.flex-split{flex-direction:column;gap:12px;}}
    .calendar-card, .records-card {
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 10px 10px 10px;
      margin-bottom:10px;
      min-width:300px;
      flex:2 1 0;
    }
    .records-card {max-width:420px;}
    .goal-card {
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    /* --- モーダル --- */
    .modal-bg {
      position:fixed;z-index:50;left:0;top:0;width:100vw;height:100vh;
      background:rgba(10,12,18,0.50);
      display:flex;align-items:center;justify-content:center;
      animation:fadein .15s;
    }
    @keyframes fadein {from{opacity:0}to{opacity:1}}
    .modal-content {
      background:var(--card);
      border-radius:14px;
      padding:32px 28px 22px 28px;
      width:320px;
      box-shadow:0 8px 32px rgba(0,0,0,0.22);
    }
    .modal-content label{font-size:15px;color:var(--muted);}
    .modal-content select{margin-top:6px;}
    .modal-actions {display:flex;gap:10px;margin-top:20px;justify-content:flex-end;}
    .modal-actions button{
      width:48%;
      min-width:90px;
      font-size:16px;
      border-radius:13px;
      padding:13px 0;
    }
    /* --- 目標履歴カード --- */
    .goal-list-card {
      margin-top:0;
    }
    .goal-hist-item {
      background:var(--goalhist-bg);
      border-radius:12px;
      margin-bottom:12px;
      padding:16px 15px 12px 15px;
      box-shadow:0 2px 10px rgba(30,40,45,0.07);
      border:1px solid rgba(100,150,110,0.10);
      max-width:440px;
      display:flex;flex-direction:column;gap:6px;
    }
    .goal-hist-period {
      font-size:15px;font-weight:600;margin-bottom:0;letter-spacing:0.2px;
    }
    .goal-hist-kpis {
      display:flex;gap:18px;flex-wrap:wrap;font-size:14px;
      margin:2px 0 0 2px;
    }
    .goal-hist-kpis .gh-kpi {color:var(--muted);}
    .goal-hist-del-btn {
      align-self:flex-end;
      padding:2px 11px;
      border-radius:8px;
      background:var(--muted);
      color:var(--bg);
      border:none;
      font-size:13px;
      margin-top:4px;
      transition:.2s;
    }
    .goal-hist-del-btn:hover {background:var(--danger);color:#fff;}
    /* --- 目標保存・削除ボタン --- */
    .goal-btns {
    display: flex;
    gap: 14px;
    justify-content: space-between;
    margin-top: 14px;
    margin-bottom: 18px; /* ←ここを追加 */
    }
    .goal-btns .primary, .goal-btns .danger {
      width:48%;min-width:90px;font-size:16px;border-radius:13px;padding:13px 0;
    }
    /* --- 週間ヒートマップ --- */
    .week-heatmap{display:grid;grid-template-columns:40px repeat(7,1fr);gap:2px;font-size:10px;margin-top:6px}
    .week-heatmap .cell{height:12px;border-radius:2px}
    .week-heatmap .week-date{cursor:pointer}
    .week-heatmap .hour-label{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--muted)}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#11161c;color:#dfe6ee;padding:10px 14px;border:1px solid rgba(255,255,255,.08);border-radius:999px;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1}
    /* カテゴリリスト（元のシンプルver） */
    .cat-list-row {
      display:flex;align-items:center;gap:6px;
      padding:7px 0 7px 4px;
      border-bottom:1px solid rgba(180,180,180,.11);
    }
    .cat-chip {
      background:var(--chip-muted);
      color:var(--chip-text);
      border-radius:12px;
      padding:5px 14px;
      font-size:14px;
      margin-right:4px;
      height:28px;
      display:flex;align-items:center;justify-content:center;
      flex:1 1 auto;white-space:nowrap;
    }
    .cat-list-row .tab-btn,
    .cat-list-row .tab-btn.danger {
      font-size:12px;
      padding:0 8px;
      border-radius:8px;
      min-width:0;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      width:auto;
    }

  </style>
</head>
<body>
  <header>
    <h1>📘 勉強記録アプリ</h1>
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="main">メイン</button>
      <button class="tab-btn" data-tab="goal">目標</button>
      <button class="tab-btn" data-tab="cats">カテゴリ</button>
      <button class="tab-btn right" id="exportBtn" title="JSONで書き出し">📤</button>
      <button class="tab-btn" id="importBtn" title="JSONを読み込み">📥</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>
  </header>
  <main>
    <!-- メイン画面 -->
    <section id="tab-main">
      <div id="summaryCard" class="summary-card">
        <div id="summaryGoalTabs" class="tabs" style="margin-bottom:6px;"></div>
        <div id="summaryContent"></div>
      </div>
      <div class="flex-split">
        <!-- カレンダー -->
        <div class="calendar-card">
          <div class="calendar-head" id="calendarNav">
            <button id="prevMonth" class="calendar-nav-btn">&lt;</button>
            <div id="monthTitle" class="calendar-title-btn"></div>
            <button id="nextMonth" class="calendar-nav-btn">&gt;</button>
            <button id="prevYear" class="calendar-nav-btn" style="display:none">&lt;</button>
            <div id="yearTitle" class="calendar-title-btn" style="display:none"></div>
            <button id="nextYear" class="calendar-nav-btn" style="display:none">&gt;</button>
            <button id="prevWeek" class="calendar-nav-btn" style="display:none">&lt;</button>
            <div id="weekTitle" class="calendar-title-btn" style="display:none"></div>
            <button id="nextWeek" class="calendar-nav-btn" style="display:none">&gt;</button>
            <select id="calendarView" class="calendar-nav-select">
              <option value="year">年</option>
              <option value="month" selected>月</option>
              <option value="week">週</option>
            </select>
          </div>
          <div class="calendar-grid" id="dowRow"></div>
          <div class="calendar-grid" id="monthGrid"></div>
          <div id="dayDetails" style="margin-top:10px"></div>
          <div id="yearView" style="display:none">
            <div id="yearGrid" class="year-grid"></div>
          </div>
          <div id="weekView" style="display:none"></div>
        </div>
        <!-- 記録入力 -->
        <div class="records-card">
          <form id="entryForm">
            <div class="form-row-flex">
              <div class="input-block">
                <label>日付</label>
                <input type="date" id="date" required>
              </div>
              <div class="input-block">
                <label>カテゴリ</label>
                <select id="category"></select>
              </div>
              <div class="input-block">
                <label>勉強時間 (m)</label>
                <input type="text" id="minutes" placeholder="例: 45" required autocomplete="off">
              </div>
            </div>
            <div class="time-input-row">
              <label>開始・終了時刻</label>
              <div class="time-fields">
                <input type="text" id="startTime" maxlength="5" placeholder="HH:MM">
                <span style="line-height:1.8;">～</span>
                <input type="text" id="endTime" maxlength="5" placeholder="HH:MM">
              </div>
            </div>
            <div class="entry-submit-row">
              <button type="submit" class="primary">記録する</button>
            </div>
          </form>
        </div>
      </div>
    </section>
      <!-- 目標 -->
      <div id="tab-goal" style="display:none">
        <section class="goal-card">
        <form id="goalForm">
        <div class="row">
          <div>
            <label>開始日</label>
            <input type="date" id="goalStart" required>
          </div>
          <div>
            <label>終了日</label>
            <input type="date" id="goalEnd" required>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>目標時間 (h)</label>
            <input type="number" id="goalHours" min="1" placeholder="例: 100" required>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>カテゴリ</label>
            <select id="goalCategory"></select>
          </div>
        </div>
        <div class="goal-btns">
          <button class="primary" type="submit">保存</button>
          <button class="danger" type="button" id="goalDeleteBtn">削除</button>
        </div>
        </form>
        <div class="progress-wrap">
        <div class="inline" style="justify-content:space-between">
          <div><strong>目標期間</strong></div>
          <div class="hint" id="goalRangeHint"></div>
        </div>
        <div class="progress" style="margin-top:8px">
          <div id="goalBar" class="progress-inner"></div>
        </div>
        <div class="kpis">
          <div class="item"><div>累計</div><div id="goalAccum" style="font-weight:700"></div></div>
          <div class="item"><div>目標</div><div id="goalTarget" style="font-weight:700"></div></div>
          <div class="item"><div>達成率</div><div id="goalPct" style="font-weight:700"></div></div>
        </div>
        <div class="hint" id="goalDaysLeft" style="margin-top:6px"></div>
        <div class="hint" id="goalCatHint" style="margin-top:4px"></div>
        <div id="activeGoalList" class="goal-list-card" style="margin-top:10px"></div>
        </div>
        </section>
        <section class="goal-card">
          <div class="goal-list-card" id="goalHistory"></div>
        </section>
      </div>
    <!-- カテゴリ管理 -->
    <section id="tab-cats" style="display:none">
      <div class="row">
        <div>
          <label>新規カテゴリ名</label>
          <input type="text" id="newCat" placeholder="例: IELTSリーディング">
        </div>
        <div style="align-self:end">
          <button id="addCat" class="primary" type="button">追加</button>
        </div>
      </div>
      <div style="margin-top:8px" id="catList" class="list"></div>
      <div class="inline" style="margin-top:12px; gap:8px">
        <button id="resetData" class="tab-btn danger" type="button">全データ削除</button>
      </div>
    </section>
  </main>
  <!-- 月選択モーダル -->
  <div id="monthModal" class="modal-bg" style="display:none">
    <div class="modal-content">
      <label>年月を選択</label>
      <div style="margin-top:8px;">
        <select id="selectYear"></select>
        <select id="selectMonth"></select>
      </div>
      <div class="modal-actions">
        <button class="secondary" id="closeMonthModal">キャンセル</button>
        <button class="primary" id="gotoMonthBtn">移動</button>
      </div>
    </div>
  </div>
  <script>
  (()=> {
    // --- 基本ユーティリティ
    const KEYS = {entries:'studyEntries_v7',cats:'studyCategories_v7',goals:'studyGoals_v7'};
    const pad=n=>String(n).padStart(2,'0');
    const todayStr=()=>{const d=new Date();return [d.getFullYear(),pad(d.getMonth()+1),pad(d.getDate())].join('-');};
    const fmtDateLabel=d=>`${d.getFullYear()}年${d.getMonth()+1}月`;
    const parseDateStr=s=>{const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,0,0,0,0);};
    const dateToStr=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const toast=msg=>{const t=document.getElementById('toast');t.textContent=msg||'保存しました';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);}
    const load=(k,fallback)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??fallback}catch(e){return fallback}};
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    let entries=load(KEYS.entries,[]),categories=load(KEYS.cats,['IELTSリーディング','単語','スピーキング','リスニング','文法','ライティング']),goals=load(KEYS.goals,[]);
    const latestGoal = ()=> goals.length ? goals[goals.length-1] : null;
    const startOfWeek=d=>{const t=new Date(d);const diff=(t.getDay()+6)%7;t.setDate(t.getDate()-diff);t.setHours(0,0,0,0);return t;};
    const weekStrFromDate=d=>{const t=new Date(d);t.setDate(t.getDate()+3);const first=new Date(t.getFullYear(),0,1);const week=Math.floor((t-first)/604800000)+1;return `${t.getFullYear()}-W${pad(week)}`;};
    const weekStrToDate=s=>{const [y,w]=s.split('-W').map(Number);const d=new Date(y,0,1);const day=(d.getDay()+6)%7;d.setDate(d.getDate()-day+(w-1)*7);return startOfWeek(d);};
    const fmtWeekLabel=start=>{
      const end=new Date(start);end.setDate(start.getDate()+6);
      return `${start.getFullYear()}/${start.getMonth()+1}/${start.getDate()}\uFF5E${end.getMonth()+1}/${end.getDate()}`;
    };
    let currentWeekStart=startOfWeek(new Date());
    let summaryGoalIndex=0;
    const activeGoals=()=>{const today=new Date();return goals.filter(g=>parseDateStr(g.start)<=today&&parseDateStr(g.end)>=today);};
    const pastGoals=()=>{const today=new Date();return goals.filter(g=>parseDateStr(g.end)<today);};
    const fmt=(n,d)=>Number(n).toLocaleString('en-US',d!==undefined?{minimumFractionDigits:d,maximumFractionDigits:d}:{});

    // --- タブ制御
    const tabBtns=[...document.querySelectorAll('.tab-btn[data-tab]')];
    const sections={
      main:document.getElementById('tab-main'),
      goal:document.getElementById('tab-goal'),
      cats:document.getElementById('tab-cats')
    };
    function setTab(name){
      for(const btn of tabBtns){btn.classList.toggle('active',btn.dataset.tab===name);}
      Object.entries(sections).forEach(([k,sec])=>{sec.style.display=(k===name)?'block':'none';});
      if(name==='main') {renderSummary(); renderWeek(); renderMonth();}
      if(name==='goal') {renderGoal(); renderActiveGoals(); renderGoalHistory();}
      if(name==='cats') renderCats();
    }
    document.getElementById('tabs').addEventListener('click',e=>{
      const t=e.target.closest('.tab-btn[data-tab]');if(!t)return;setTab(t.dataset.tab);
    });
    document.getElementById('summaryGoalTabs').addEventListener('click',e=>{
      const i=e.target?.dataset?.selgoal;
      if(i!==undefined){summaryGoalIndex=Number(i);renderSummary();}
    });

    // --- サマリー（メイン画面上部カード）
    function renderSummary() {
      const wrap=document.getElementById('summaryContent');
      const tabWrap=document.getElementById('summaryGoalTabs');
      if(!entries.length){wrap.innerHTML='<div class="muted">まだ記録がありません。</div>';tabWrap.innerHTML='';return;}
      const goalsAct=activeGoals();
      if(summaryGoalIndex>=goalsAct.length) summaryGoalIndex=0;
      tabWrap.innerHTML=goalsAct.map((g,i)=>`<button class="tab-btn ${i===summaryGoalIndex?'active':''}" data-selgoal="${i}">${g.category&&g.category!=='all'?g.category:'総合'}</button>`).join('');
      const goal=goalsAct[summaryGoalIndex];
      // 合計
      let totalMin = entries.reduce((a,b)=>a+b.minutes,0);
      if(goal && goal.start && goal.end){
        const s=parseDateStr(goal.start),e=parseDateStr(goal.end);
        totalMin = entries
          .filter(x=>{const d=parseDateStr(x.date);return d>=s&&d<=e && (goal.category==='all' || !goal.category || x.category===goal.category);})
          .reduce((a,b)=>a+b.minutes,0);
      }
      const totalH = fmt(totalMin/60,1);
      const rangeEntries = entries.filter(x=>{
        if(goal && goal.start && goal.end){
          const d=parseDateStr(x.date);
          if(d<parseDateStr(goal.start)||d>parseDateStr(goal.end)) return false;
        }
        return true;
      });
      const catTotals={};
      rangeEntries.forEach(e=>{catTotals[e.category]=(catTotals[e.category]||0)+e.minutes;});
      // 記録開始日数:目標開始基準
      let startDate = entries.map(e=>e.date).sort()[0];
      let days = 1, goalPeriod = "";
      if(goal && goal.start && goal.end){
        startDate = goal.start;
        const lastDate = todayStr();
        days = Math.max(1, Math.round((parseDateStr(lastDate) - parseDateStr(startDate))/86400000) + 1);
        goalPeriod = `<span class="muted" style="font-size:12px;display:block;margin-top:3px;">目標期間：${goal.start}〜${goal.end}</span>`;
      }
      // 目標
      let tgt = 0, pct = 0, predict = '';
      if (goal) {
        tgt = goal.targetMin;
        pct = Math.min(100, Math.round((totalMin / Math.max(1,tgt))*100));
        // 予測日数
        const avg = totalMin/days;
        if (avg > 0 && totalMin < tgt) {
          const remain = tgt-totalMin;
          const estDays = Math.ceil(remain/avg);
          const d = new Date();
          d.setDate(d.getDate()+estDays);
          predict = `${fmt(estDays)}日後（${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}）`;
        } else if (totalMin >= tgt && tgt > 0) {
          predict = '達成済み';
        }
      }
      wrap.innerHTML = `
        <div class="summary-kpi">合計 <span style="font-weight:700">${totalH}</span> h  (${fmt(totalMin)} m)</div>
        <div class="summary-progress-bar"><div class="summary-progress-bar-inner" id="mainProgressBar"></div></div>
        <div class="summary-list">
          <div>
            記録開始から <span style="font-weight:600">${fmt(days)}</span> 日間
            ${goalPeriod}
          </div>
          <div>目標：${tgt?fmt(tgt/60,1)+'h':'—'}（達成率${fmt(pct||0)}%）</div>
          <div>目標到達予測：${predict||'—'}</div>
        </div>
        <div class="summary-list" style="margin-top:4px;">
          ${Object.entries(catTotals).map(([c,v])=>`<div>${c}: <b>${fmt(v/60,1)}</b>h</div>`).join('')}
        </div>
      `;
      // 進捗バー描画
      document.getElementById('mainProgressBar').style.width = pct + '%';
    }

    function weekHeatmapHTML(start){
      const heat=Array.from({length:7},()=>Array(24).fill(0));
      for(let i=0;i<7;i++){
        const d=new Date(start.getFullYear(),start.getMonth(),start.getDate()+i);
        const key=dateToStr(d);
        const list=entries.filter(e=>e.date===key);
        list.forEach(e=>{if(!e.startTime||!e.endTime)return;const [sh,sm]=e.startTime.split(':').map(Number);const [eh,em]=e.endTime.split(':').map(Number);let st=sh*60+sm,et=eh*60+em;for(let h=0;h<24;h++){const hs=h*60,he=(h+1)*60;const overlap=Math.max(0,Math.min(et,he)-Math.max(st,hs));heat[i][h]+=overlap;}});
      }
      const groups=2,groupCount=24/groups;const heatAgg=Array.from({length:7},()=>Array(groupCount).fill(0));
      for(let d=0;d<7;d++){for(let h=0;h<24;h++){const g=Math.floor(h/groups);heatAgg[d][g]+=heat[d][h];}}
      const max=heatAgg.flat().reduce((a,b)=>Math.max(a,b),0);
  let html='<div class="week-heatmap"><div></div>';
      for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);const ds=dateToStr(d);html+=`<div class="week-date" data-date="${ds}" style="text-align:center;font-size:11px">${pad(d.getMonth()+1)}/${pad(d.getDate())}</div>`;}
      for(let g=0;g<groupCount;g++){const label=`${pad(g*groups)}-${pad(g*groups+groups)}`;html+=`<div class="hour-label">${label}</div>`;for(let d=0;d<7;d++){const day=new Date(start);day.setDate(start.getDate()+d);const ds=dateToStr(day);const v=heatAgg[d][g];const lvl=v===0?0:Math.min(4,Math.ceil((v/(max||1))*4));html+=`<div class="cell lvl${lvl}" data-date="${ds}"></div>`;}}html+='</div>';
  return html;
}

    // empty renderer (week view handled separately)
    function renderWeek(){
      weekView.innerHTML=weekHeatmapHTML(currentWeekStart);
      weekTitle.textContent=fmtWeekLabel(currentWeekStart);
    }

    // --- カテゴリ選択
    const catSel=document.getElementById('category');
    const goalCatSel=document.getElementById('goalCategory');
    function renderCategorySelect(){
      catSel.innerHTML='';
      goalCatSel.innerHTML='<option value="all">全て</option>';
      categories.forEach(c=>{
        const o=document.createElement('option');o.value=c;o.textContent=c;catSel.appendChild(o);
        const g=document.createElement('option');g.value=c;g.textContent=c;goalCatSel.appendChild(g);
      });
    }

    // --- 記録フォーム
    const form=document.getElementById('entryForm'),dateEl=document.getElementById('date'),minEl=document.getElementById('minutes'),
      startEl=document.getElementById('startTime'),endEl=document.getElementById('endTime');
    function estimateTimes(){
      const mins=Number(minEl.value||0);if(!mins){return;}
      const end=new Date(),start=new Date(end.getTime()-mins*60000);
      const fmt=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      startEl.value=fmt(start);endEl.value=fmt(end);
    }
    minEl.addEventListener('input',estimateTimes);
    dateEl.addEventListener('change',estimateTimes);
    // 記録
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const minutes=Number(minEl.value),cat=catSel.value,st=startEl.value,endt=endEl.value;
      if(!minutes||minutes<=0||!cat)return;
      const dStr = dateEl.value||todayStr();
      entries.push({id:Date.now().toString(36),date:dStr,minutes,category:cat,createdAt:Date.now(),startTime:st,endTime:endt});
      save(KEYS.entries,entries);minEl.value='';estimateTimes();toast();
      renderAll();
      if(calendarViewSel.value==='week'){
        renderWeek();
      }
      setCalendarView(calendarViewSel.value);
    });

    // --- カレンダー表示 + 月選択モーダル
    const dowRow=document.getElementById('dowRow'),
      monthGrid=document.getElementById('monthGrid'),
      monthTitle=document.getElementById('monthTitle'),
      prevMonthBtn=document.getElementById('prevMonth'),
      nextMonthBtn=document.getElementById('nextMonth'),
      dayDetails=document.getElementById('dayDetails'),
      calendarViewSel=document.getElementById('calendarView'),
      yearView=document.getElementById('yearView'),
      weekView=document.getElementById('weekView'),
      yearGrid=document.getElementById('yearGrid'),
      yearTitle=document.getElementById('yearTitle'),
      prevYearBtn=document.getElementById('prevYear'),
      nextYearBtn=document.getElementById('nextYear'),
      prevWeekBtn=document.getElementById("prevWeek"),
      nextWeekBtn=document.getElementById("nextWeek"),
      weekTitle=document.getElementById("weekTitle");
    let activeDayDetail=null;
    const DOW=['月','火','水','木','金','土','日'];
    let currentYM={y:new Date().getFullYear(),m:new Date().getMonth()};
    let currentYear=currentYM.y;
    function renderMonth(){
      dowRow.innerHTML=DOW.map(d=>`<div class="dow">${d}</div>`).join('');
      const y=currentYM.y,m=currentYM.m;monthTitle.textContent=fmtDateLabel(new Date(y,m,1));
      const lastDate=new Date(y,m+1,0).getDate();const totals={};let monthMax=0;
      for(let d=1;d<=lastDate;d++){const key=`${y}-${pad(m+1)}-${pad(d)}`;const sum=entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);totals[key]=sum;monthMax=Math.max(monthMax,sum);}
      const firstDow=(new Date(y,m,1).getDay()+6)%7;const blanks=Array.from({length:firstDow},()=>'<div></div>').join('');
      monthGrid.innerHTML=blanks+Array.from({length:lastDate},(_,i)=>{
        const d=i+1,key=`${y}-${pad(m+1)}-${pad(d)}`,sum=totals[key]||0;
        const level=sum===0?0:Math.min(4,Math.ceil((sum/(monthMax||1))*4));const isToday=key===todayStr();
        return `<div class="day lvl${level} ${isToday?'today':''}" data-date="${key}"><div class="num">${d}</div><div class="mins">${sum?fmt(sum)+'m':''}</div></div>`;
      }).join('');
      dayDetails.innerHTML='';
    }
    function renderDayDetails(d){
      activeDayDetail=d;
      const list=entries.filter(x=>x.date===d).sort((a,b)=>b.createdAt-a.createdAt),total=list.reduce((a,b)=>a+b.minutes,0);
      dayDetails.innerHTML=`
        <div class="day-detail-wrap">
          <div class="day-detail-title">${d}</div>
          <div class="day-detail-total">合計 <strong>${fmt(total/60,1)}</strong>h (${fmt(total)}m)</div>
          <div class="day-detail-list">
            ${list.length?list.map(e=>`
              <div class="rec-row">
                <span class="chip muted">${e.category}</span>
                <span style="font-size:13px;color:var(--muted)">${fmt(e.minutes)}m${(e.startTime&&e.endTime)?`（${e.startTime}～${e.endTime}）`:''}</span>
                <button class="del-btn" data-del="${e.id}">×</button>
              </div>
            `).join(''):`<div class="muted" style="padding:10px 0 0 4px;">記録なし</div>`}
          </div>
        </div>
      `;
    }
    monthGrid.addEventListener('click',e=>{
      const d=e.target.closest('.day')?.dataset?.date;if(!d)return;
      renderDayDetails(d);
    });
    dayDetails.addEventListener('click',e=>{
      const id=e.target?.dataset?.del; if(!id) return;
      const {clientX, clientY} = e;
      const row = e.target.closest('.rec-row');
      const btnBefore = e.target.classList.contains('del-btn') ? e.target : null;
      if(btnBefore) btnBefore.classList.add('no-hover');
      entries = entries.filter(x => String(x.id) !== String(id));
      save(KEYS.entries, entries);
      toast('削除しました');
      renderSummary();
      renderWeek();
      renderYear();
      renderGoal();
      renderActiveGoals();
      renderGoalHistory();
      if(activeDayDetail) renderDayDetails(activeDayDetail);
      renderMonth();
      setCalendarView(calendarViewSel.value);
      const btn = document.elementFromPoint(clientX, clientY);
      if(row) row.remove();
      if(btn?.classList.contains('del-btn')){
        btn.classList.add('no-hover');
        btn.addEventListener('mouseleave', ()=>{
          btn.classList.remove('no-hover');
        }, {once:true});
      }
    });

    prevMonthBtn.addEventListener('click',()=>{if(currentYM.m===0){currentYM.y--;currentYM.m=11;}else currentYM.m--;renderMonth();});
    nextMonthBtn.addEventListener('click',()=>{if(currentYM.m===11){currentYM.y++;currentYM.m=0;}else currentYM.m++;renderMonth();});

    function renderMiniMonth(y,m){
      const lastDate=new Date(y,m+1,0).getDate();
      const totals={};let monthMax=0;
      for(let d=1;d<=lastDate;d++){
        const key=`${y}-${pad(m+1)}-${pad(d)}`;
        const sum=entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);
        totals[key]=sum;monthMax=Math.max(monthMax,sum);
      }
      const firstDow=(new Date(y,m,1).getDay()+6)%7;
      const blanks=Array.from({length:firstDow},()=>'<div class="mini-day"></div>').join('');
      const days=Array.from({length:lastDate},(_,i)=>{
        const d=i+1,key=`${y}-${pad(m+1)}-${pad(d)}`;
        const sum=totals[key]||0;
        const level=sum===0?0:Math.min(4,Math.ceil((sum/(monthMax||1))*4));
        const today=key===todayStr()? 'today' : '';
        return `<div class="mini-day lvl${level} ${today}">${d}</div>`;
      }).join('');
      return `<div class="mini-month" data-y="${y}" data-m="${m}"><div class="mini-month-name">${m+1}月</div><div class="mini-month-grid">${blanks+days}</div></div>`;
    }

    function renderYear(){
      yearTitle.textContent=currentYear+'年';
      yearGrid.innerHTML=Array.from({length:12},(_,i)=>renderMiniMonth(currentYear,i)).join('');
    }

    function setCalendarView(view){
      calendarViewSel.value=view;
      if(view==='year'){
        yearView.style.display='block';
        weekView.style.display='none';
        dowRow.style.display='none';
        monthGrid.style.display='none';
        monthGrid.after(dayDetails);
        dayDetails.style.display='none';
        prevMonthBtn.style.display='none';
        nextMonthBtn.style.display='none';
        monthTitle.style.display='none';
        prevYearBtn.style.display='';
        nextYearBtn.style.display='';
        yearTitle.style.display='';
        currentYear=currentYM.y;
        prevWeekBtn.style.display="none";
        nextWeekBtn.style.display="none";
        weekTitle.style.display="none";
        renderYear();
      } else if(view==='week') {
          yearView.style.display="none";
          weekView.style.display="block";
          renderWeek();
          weekView.after(dayDetails);
          dowRow.style.display="none";
          monthGrid.style.display="none";
          dayDetails.style.display="none";
          prevMonthBtn.style.display="none";
          nextMonthBtn.style.display="none";
          monthTitle.style.display="none";
          prevYearBtn.style.display="none";
          nextYearBtn.style.display="none";
          yearTitle.style.display="none";
          prevWeekBtn.style.display="";
          nextWeekBtn.style.display="";
          weekTitle.style.display="";
      } else {
          yearView.style.display='none';
          weekView.style.display='none';
          dowRow.style.display='grid';
          monthGrid.style.display='grid';
        monthGrid.after(dayDetails);
        dayDetails.style.display='';
        prevMonthBtn.style.display='';
        nextMonthBtn.style.display='';
        monthTitle.style.display='';
        prevYearBtn.style.display='none';
        nextYearBtn.style.display='none';
        yearTitle.style.display='none';
        prevWeekBtn.style.display="none";
        nextWeekBtn.style.display="none";
        weekTitle.style.display="none";
      }
    }

    calendarViewSel.addEventListener('change',e=>{
      setCalendarView(e.target.value);
    });
    prevYearBtn.addEventListener('click',()=>{currentYear--;renderYear();});
    nextYearBtn.addEventListener('click',()=>{currentYear++;renderYear();});
    prevWeekBtn.addEventListener("click",()=>{currentWeekStart.setDate(currentWeekStart.getDate()-7);dayDetails.style.display='none';renderWeek();});
    nextWeekBtn.addEventListener("click",()=>{currentWeekStart.setDate(currentWeekStart.getDate()+7);dayDetails.style.display='none';renderWeek();});
    weekView.addEventListener('click',e=>{
      const t=e.target.closest('.cell, .week-date');
      if(!t) return;
      const d=t.dataset.date;
      if(!d) return;
      dayDetails.style.display='';
      renderDayDetails(d);
    });
    yearGrid.addEventListener('click',e=>{
      const t=e.target.closest('.mini-month');
      if(!t)return;
      const y=parseInt(t.dataset.y),m=parseInt(t.dataset.m);
      currentYM={y,m};
      setCalendarView('month');
      renderMonth();
    });
    // 月選択モーダル制御
    const monthModal=document.getElementById('monthModal');
    monthTitle.addEventListener('click',()=>{
      showMonthModal(currentYM.y,currentYM.m);
    });
    function showMonthModal(selectedY,selectedM){
      const y0=new Date().getFullYear();
      let yRange=[]; for(let y=y0-5;y<=y0+1;y++) yRange.push(y);
      let yearSel=document.getElementById('selectYear'),monthSel=document.getElementById('selectMonth');
      yearSel.innerHTML=yRange.map(y=>`<option value="${y}">${y}年</option>`).join('');
      yearSel.value=selectedY;
      monthSel.innerHTML=Array.from({length:12},(_,i)=>`<option value="${i}">${i+1}月</option>`).join('');
      monthSel.value=selectedM;
      monthModal.style.display='flex';
    }
    document.getElementById('closeMonthModal').onclick=()=>{monthModal.style.display='none';};
    document.getElementById('gotoMonthBtn').onclick=()=>{
      const y=parseInt(document.getElementById('selectYear').value);
      const m=parseInt(document.getElementById('selectMonth').value);
      currentYM={y,m}; monthModal.style.display='none'; renderMonth();
    };

    // --- 目標管理
    const goalForm=document.getElementById('goalForm'),goalStart=document.getElementById('goalStart'),goalEnd=document.getElementById('goalEnd'),goalHours=document.getElementById('goalHours'),
      goalBar=document.getElementById('goalBar'),goalAccum=document.getElementById('goalAccum'),goalTarget=document.getElementById('goalTarget'),goalPct=document.getElementById('goalPct'),
      goalRangeHint=document.getElementById('goalRangeHint'),goalDaysLeft=document.getElementById('goalDaysLeft'),goalDeleteBtn=document.getElementById('goalDeleteBtn'),
      goalHistory=document.getElementById('goalHistory'),activeGoalList=document.getElementById('activeGoalList');
    function goalStats(g){
      const s=parseDateStr(g.start),e=parseDateStr(g.end);
      const accum=entries.filter(x=>{
        const d=parseDateStr(x.date);
        if(d<s||d>e) return false;
        if(g.category && g.category!=='all' && x.category!==g.category) return false;
        return true;
      }).reduce((a,b)=>a+b.minutes,0);
      const target=g.targetMin;
      const pct=Math.min(100,Math.round((accum/Math.max(1,target))*100));
      return {accum,target,pct};
    }
    function renderGoal(){
      const g = latestGoal();
      if(g){
        goalStart.value=g.start;goalEnd.value=g.end;goalHours.value=Math.round(g.targetMin/60);
        goalCatSel.value=g.category||'all';
      } else {
        goalStart.value='';goalEnd.value='';goalHours.value='';goalCatSel.value='all';
      }
      goalRangeHint.textContent=g?`${g.start}〜${g.end}`:'未設定';
      let accum=0,target=0,pct=0,left='';
      if(g){
        const stats=goalStats(g);
        accum=stats.accum;target=stats.target;pct=stats.pct;
        const daysLeft=Math.max(0,Math.ceil((parseDateStr(g.end)-new Date())/86400000));
        left=`終了まで残り ${fmt(daysLeft)} 日`;
      }
      goalBar.style.width=pct+'%';
      goalAccum.textContent=g?`${fmt(accum/60,1)}h (${fmt(accum)}m)`:'—';
      goalTarget.textContent=g?`${fmt(target/60,1)}h (${fmt(target)}m)`:'—';
      goalPct.textContent=g?`${fmt(pct)}%`:'—';
      goalDaysLeft.textContent=g?left:'';
      goalCatHint.textContent=g?`カテゴリ: ${g.category&&g.category!=='all'?g.category:'全て'}`:'';
    }
    function renderActiveGoals(){
      const acts=activeGoals();
      if(!acts.length){activeGoalList.innerHTML='<div class="muted">現在の目標なし</div>';return;}
      activeGoalList.innerHTML='<h3 style="margin:8px 0 6px 4px;">現在の目標</h3>'+
        acts.map(g=>{const idx=goals.indexOf(g);const s=goalStats(g);return `<div class="goal-hist-item"><div class="goal-hist-period">${g.start}〜${g.end} [${g.category&&g.category!=='all'?g.category:'全て'}]</div><div class="goal-hist-kpis"><span class="gh-kpi">累計: <b>${fmt(s.accum/60,1)}h</b></span><span class="gh-kpi">目標: <b>${fmt(g.targetMin/60,1)}h</b></span><span class="gh-kpi">達成率: <b>${fmt(s.pct)}%</b></span></div><button class="goal-hist-del-btn" data-goaldel="${idx}">×</button></div>`;}).join('');
    }
    // 目標履歴
    function renderGoalHistory(){
      const past=pastGoals();
      if(!past.length){goalHistory.innerHTML='<div class="muted">過去の目標なし</div>';return;}
      goalHistory.innerHTML='<h3 style="margin:8px 0 6px 4px;">過去の目標</h3>'+
        past.slice().reverse().map(g=>{const idx=goals.indexOf(g);const stats=goalStats(g);return `<div class="goal-hist-item">
            <div class="goal-hist-period">${g.start}〜${g.end} [${g.category&&g.category!=='all'?g.category:'全て'}]</div>
            <div class="goal-hist-kpis">
              <span class="gh-kpi">累計: <b>${fmt(stats.accum/60,1)}h</b></span>
              <span class="gh-kpi">目標: <b>${fmt(g.targetMin/60,1)}h</b></span>
              <span class="gh-kpi">達成率: <b>${fmt(stats.pct)}%</b></span>
            </div>
            <button class="goal-hist-del-btn" data-goaldel="${idx}">×</button>
          </div>`;}).join('');
    }
    document.getElementById('tab-goal').addEventListener('click',e=>{
      const idx=e.target?.dataset?.goaldel;
      if(idx!==undefined){
        const {clientX, clientY}=e;
        goals.splice(idx,1);
        save(KEYS.goals,goals);
        renderGoalHistory();
        renderActiveGoals();
        renderSummary();
        renderWeek();
        const btn=document.elementFromPoint(clientX,clientY);
        if(btn?.classList.contains('goal-hist-del-btn')){
          btn.style.background='var(--muted)';
          btn.style.color='var(--bg)';
          btn.addEventListener('mouseleave',()=>{
            btn.style.background='';
            btn.style.color='';
          },{once:true});
        }
        toast('削除しました');
      }
    });

    goalForm.addEventListener('submit',e=>{
      e.preventDefault();
      const start=goalStart.value,end=goalEnd.value,hours=Number(goalHours.value||0),cat=goalCatSel.value||'all';
      if(!start||!end||!hours)return;
      goals.push({start,end,targetMin:hours*60,category:cat});
      save(KEYS.goals,goals);toast('保存');renderGoal();renderActiveGoals();renderGoalHistory();renderSummary();renderWeek();
    });
    goalDeleteBtn.addEventListener('click',()=>{
      if(!goals.length) return;
      if(!confirm('最新の目標を削除しますか？'))return;
      goals.pop();
      save(KEYS.goals,goals);renderGoal();renderActiveGoals();renderGoalHistory();renderSummary();renderWeek();
    });

    // --- カテゴリ管理
    const newCat=document.getElementById('newCat'),addCatBtn=document.getElementById('addCat'),catList=document.getElementById('catList'),resetData=document.getElementById('resetData');
    function renderCats(){
      catList.innerHTML=categories.map((c,i)=>`
        <div class="cat-list-row">
          <span class="cat-chip">${c}</span>
          <button class="tab-btn" data-up="${i}">↑</button>
          <button class="tab-btn" data-down="${i}">↓</button>
          <button class="tab-btn danger" data-del="${i}">削除</button>
        </div>
      `).join('')||`<div class="hint">カテゴリがありません。追加してください。</div>`;
    }
    addCatBtn.addEventListener('click',()=>{
      const name=(newCat.value||'').trim();if(!name)return;if(categories.includes(name)){toast('既に存在します');return;}
      categories.push(name);save(KEYS.cats,categories);newCat.value='';renderCategorySelect();renderCats();toast('追加しました');
    });
    catList.addEventListener('click',e=>{
      const i=e.target?.dataset?.del;if(i!==undefined){
        const name=categories[i],used=entries.some(x=>x.category===name);
        if(used){alert('このカテゴリの記録が存在します。先に記録を変更/削除してください。');return;}
        categories.splice(i,1);save(KEYS.cats,categories);renderCategorySelect();renderCats();toast('削除しました');return;}
      const up=e.target?.dataset?.up,down=e.target?.dataset?.down;
      if(up!==undefined){const idx=Number(up);if(idx>0){[categories[idx-1],categories[idx]]=[categories[idx],categories[idx-1]];save(KEYS.cats,categories);renderCategorySelect();renderCats();}}
      if(down!==undefined){const idx=Number(down);if(idx<categories.length-1){[categories[idx+1],categories[idx]]=[categories[idx],categories[idx+1]];save(KEYS.cats,categories);renderCategorySelect();renderCats();}}
    });
    resetData.addEventListener('click',()=>{
      if(!confirm('本当に全データ（記録・カテゴリ・目標）を削除しますか？'))return;
      localStorage.removeItem(KEYS.entries);localStorage.removeItem(KEYS.cats);localStorage.removeItem(KEYS.goals);
      entries=[];categories=['IELTSリーディング','単語','スピーキング','リスニング','文法','ライティング'];goals=[];
      save(KEYS.cats,categories);renderAll();toast('初期化しました');
    });

    // --- JSONエクスポート/インポート
    document.getElementById('exportBtn').addEventListener('click',()=>{
      const data={entries,categories,goals,exportedAt:new Date().toISOString()};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download=`study_backup_${Date.now()}.json`;a.click();URL.revokeObjectURL(a.href);
    });
    document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change',async()=>{
      const f=document.getElementById('importFile').files[0];if(!f)return;const text=await f.text();
      try{const data=JSON.parse(text);if(!data||!Array.isArray(data.entries))throw new Error('不正な形式');
        entries=data.entries;categories=data.categories||categories;goals=data.goals||[];
        save(KEYS.entries,entries);save(KEYS.cats,categories);save(KEYS.goals,goals);renderAll();toast('読み込みました');
      }catch(err){alert('読み込みに失敗:'+err.message);}finally{document.getElementById('importFile').value='';}
    });

    // --- 全体レンダリング
    function renderAll(){
      renderCategorySelect();
      renderSummary();
      renderWeek();
      renderMonth();
      renderYear();
      renderGoal();
      renderActiveGoals();
      renderGoalHistory();
      renderCats();
      setCalendarView(calendarViewSel.value);
    }
    function init(){dateEl.value=todayStr();estimateTimes();renderAll();}
    init();

  })();
  </script>
</body>
</html>
