<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>勉強記録（ローカル）</title>
<style>
  :root{
    --bg: #0f1115;
    --card: #171a21;
    --text: #dfe6ee;
    --muted: #98a2b3;
    --accent: #4ea46e;
    --accent-2:#2c7a4a;
    --danger:#f25f5c;

    /* GitHub風 濃淡 */
    --lvl0:#2a2e36;      /* 0分 */
    --lvl1:#284e32;      /* 少 */
    --lvl2:#2f6e3e;      /* 中 */
    --lvl3:#2f8e4a;      /* 多 */
    --lvl4:#31a65a;      /* 特多 */
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f7f8fb;
      --card: #ffffff;
      --text:#111;
      --muted:#667085;
      --accent:#2ea043;
      --accent-2:#1f7a32;
      --lvl0:#ebedf0;
      --lvl1:#c6e48b;
      --lvl2:#7bc96f;
      --lvl3:#239a3b;
      --lvl4:#196127;
    }
  }

  *{box-sizing:border-box}
  html{ -webkit-text-size-adjust:100%; scroll-behavior:smooth; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:var(--bg);
    line-height:1.5;
    overscroll-behavior-y: contain;
  }
  header{
    position:sticky; top:0; z-index:5;
    background:var(--bg);
    padding:12px 12px 8px;
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  h1{margin:0; font-size:18px}
  .sub{color:var(--muted); font-size:12px; display:none } /* 不要表示を非表示 */

  .tabs{
    display:flex; gap:8px; margin-top:8px; overflow:auto; padding-bottom:4px;
  }
  .tab-btn{
    white-space:nowrap;
    border:1px solid rgba(255,255,255,.12);
    background:var(--card);
    color:var(--text);
    padding:10px 14px; border-radius:999px; font-size:16px; /* 16px以上でiOSのズーム防止 */
    touch-action:manipulation; outline:none;
  }
  .tab-btn:focus{outline:none}
  .tab-btn.active{border-color:var(--accent); box-shadow:0 0 0 2px rgba(78,164,110,.2) inset}
  main{padding:12px; max-width:980px; margin:0 auto}
  section{
    background:var(--card);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px; padding:12px; margin-bottom:12px;
    scroll-margin-top: 72px; /* ヘッダー分の余白 */
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  @media (max-width:640px){ .row{grid-template-columns:1fr} }

  label{font-size:12px; color:var(--muted)}
  input, select, button, textarea{
    width:100%; padding:12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.12);
    background:#0e1016; color:var(--text); font-size:16px; /* 16px以上でiOSのズーム防止 */
    outline:none;
  }
  @media (prefers-color-scheme: light){
    input, select, button, textarea{background:#fff; color:#111; border-color:#e5e7eb}
  }
  button.primary{background:var(--accent); color:white; border:none; font-weight:600}
  button.secondary{background:transparent}
  .btn-sm{padding:6px 8px; font-size:12px} /* 小型ボタン */
  .inline{display:flex; gap:8px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#10131a; border:1px solid rgba(255,255,255,.08); font-size:12px}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .hint{font-size:12px; color:var(--muted)}
  .danger{color:var(--danger)}

  /* カレンダー（月） */
  .calendar-head{
    display:flex; align-items:center; gap:8px; margin-bottom:8px
  }
  .calendar-grid{
    display:grid; gap:4px;
    grid-template-columns: repeat(7, 1fr);
  }
  .dow{font-size:12px; color:var(--muted); text-align:center}
  .day{
    aspect-ratio:1/1; border-radius:6px; padding:4px; position:relative;
    display:flex; flex-direction:column; justify-content:space-between;
    background:var(--lvl0); cursor:pointer;
  }
  .day .num{font-size:12px; opacity:.9}
  .day .mins{font-size:11px; text-align:right; opacity:.95}
  .lvl0{background:var(--lvl0)}
  .lvl1{background:var(--lvl1)}
  .lvl2{background:var(--lvl2)}
  .lvl3{background:var(--lvl3)}
  .lvl4{background:var(--lvl4)}
  .day.today{outline:2px solid var(--accent); outline-offset:0}

  /* 週バー */
  .bars{display:flex; gap:8px; align-items:flex-end; height:180px; padding:8px 4px; border-radius:10px; background:#0e1118; border:1px solid rgba(255,255,255,.06)}
  @media (prefers-color-scheme: light){ .bars{background:#fff; border-color:#e5e7eb} }
  .bar{flex:1; display:flex; flex-direction:column; align-items:center; gap:6px}
  .bar .val{font-size:11px}
  .bar .col{width:100%; border-radius:6px; background:var(--accent); min-height:2px}
  .bar label{font-size:11px; text-align:center}

  .list{display:flex; flex-direction:column; gap:8px}
  .item{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:10px; background:#0d0f15}
  @media (prefers-color-scheme: light){ .item{background:#fff; border-color:#e5e7eb} }

  /* 目標プログレス */
  .progress-wrap{background:#0e1118; border:1px solid rgba(255,255,255,.06); padding:10px; border-radius:10px}
  @media (prefers-color-scheme: light){ .progress-wrap{background:#fff; border-color:#e5e7eb} }
  .progress{height:14px; background:#2a2e36; border-radius:999px; overflow:hidden}
  .progress > div{height:100%; background:var(--accent); width:0%}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px}
  @media (max-width:560px){ .kpis{grid-template-columns:1fr 1fr} }

  .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#11161c; color:#dfe6ee; padding:10px 14px; border:1px solid rgba(255,255,255,.08); border-radius:999px; opacity:0; pointer-events:none; transition:.25s}
  .toast.show{opacity:1}

  .footer-note{font-size:11px; color:var(--muted); text-align:center; margin:16px 0 32px}
</style>
</head>
<body>
  <header>
    <h1>📘 勉強記録</h1>
    <!-- まさの要望により、ローカル保存の注意書きを非表示化 -->
    <div class="tabs" id="tabs">
      <button class="tab-btn" data-tab="input">記録</button>
      <button class="tab-btn active" data-tab="month">月</button>
      <button class="tab-btn" data-tab="week">週</button>
      <!-- 日タブは不要のため削除 -->
      <button class="tab-btn" data-tab="goal">目標</button>
      <button class="tab-btn" data-tab="cats">カテゴリ</button>
      <button class="tab-btn right" id="exportBtn" title="JSONで書き出し">📤</button>
      <button class="tab-btn" id="importBtn" title="JSONを読み込み">📥</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>
  </header>

  <main>
    <!-- 月カレンダー（メイン画面） -->
    <section id="tab-month">
      <div class="calendar-head">
        <button id="prevMonth" class="tab-btn btn-sm">←</button>
        <div id="monthTitle" style="font-weight:700"></div>
        <button id="nextMonth" class="tab-btn btn-sm">→</button>
        <button id="thisMonth" class="tab-btn btn-sm">今月</button>
        <!-- 凡例は不要のため削除 -->
      </div>
      <div class="calendar-grid" id="dowRow"></div>
      <div class="calendar-grid" id="monthGrid"></div>

      <div id="dayDetails" style="margin-top:10px"></div>
    </section>

    <!-- 入力（「月」画面の下に配置。記録タップでここへスクロール） -->
    <section id="tab-input">
      <form id="entryForm">
        <div class="row">
          <div>
            <label>日付</label>
            <input type="date" id="date" required>
          </div>
          <div>
            <label>時間（分）</label>
            <!-- 数字キーボードを避けたい要望により text に変更 -->
            <input type="text" id="minutes" placeholder="例: 45" required>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>カテゴリ</label>
            <select id="category"></select>
          </div>
          <div class="inline" style="align-items:end">
            <!-- 推定UIは表示せず、デフォルトで推定 → 下の時刻入力に反映。手動編集可 -->
            <div class="row" style="width:100%">
              <div>
                <label>開始時刻</label>
                <input type="time" id="startTime">
              </div>
              <div>
                <label>終了時刻</label>
                <input type="time" id="endTime">
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div><button type="submit" class="primary">記録する</button></div>
          <!-- 「今日にセット」ボタンは不要のため削除 -->
        </div>
      </form>

      <!-- 自動更新の注意書きは不要のため削除 -->

      <div style="margin-top:12px">
        <strong>直近の記録</strong>
        <div class="list" id="recentList"></div>
      </div>
    </section>

    <!-- 週集計 -->
    <section id="tab-week" style="display:none">
      <div class="inline" style="justify-content:space-between">
        <div><strong>直近8週間の合計（週は月曜開始）</strong></div>
        <div class="hint" id="weekTotalHint"></div>
      </div>
      <div class="bars" id="weekBars" style="margin-top:8px"></div>
      <div class="list" id="weekTable" style="margin-top:8px"></div>
    </section>

    <!-- 目標 -->
    <section id="tab-goal" style="display:none">
      <form id="goalForm">
        <div class="row">
          <div>
            <label>開始日</label>
            <input type="date" id="goalStart" required>
          </div>
          <div>
            <label>終了日</label>
            <input type="date" id="goalEnd" required>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>目標時間（時間）</label>
            <input type="number" id="goalHours" min="1" placeholder="例: 100" required>
          </div>
          <div style="align-self:end" class="inline">
            <button class="primary" type="submit">目標を保存</button>
            <button class="tab-btn btn-sm danger" id="deleteGoal" type="button" title="目標を削除">削除</button>
          </div>
        </div>
      </form>

      <div class="progress-wrap" style="margin-top:12px">
        <div class="inline" style="justify-content:space-between">
          <div><strong>目標達成率</strong></div>
          <div class="hint" id="goalRangeHint"></div>
        </div>
        <div class="progress" style="margin-top:8px">
          <div id="goalBar"></div>
        </div>
        <div class="kpis">
          <div class="item">
            <div>累計</div>
            <div id="goalAccum" style="font-weight:700"></div>
          </div>
          <div class="item">
            <div>目標</div>
            <div id="goalTarget" style="font-weight:700"></div>
          </div>
          <div class="item">
            <div>達成率</div>
            <div id="goalPct" style="font-weight:700"></div>
          </div>
        </div>
        <div class="hint" id="goalDaysLeft" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- カテゴリ管理 -->
    <section id="tab-cats" style="display:none">
      <div class="row">
        <div>
          <label>新規カテゴリ名</label>
          <input type="text" id="newCat" placeholder="例: IELTSリーディング">
        </div>
        <div style="align-self:end">
          <button id="addCat" class="primary" type="button">追加</button>
        </div>
      </div>
      <div style="margin-top:8px" id="catList" class="list"></div>

      <div class="inline" style="margin-top:12px; gap:8px">
        <button id="resetData" class="tab-btn danger" type="button">全データ削除</button>
        <!-- 下の注意書きは不要のため削除 -->
      </div>
    </section>

    <div class="footer-note">v1.1 / すべてブラウザ内で動作</div>
  </main>

  <div class="toast" id="toast">保存しました</div>

<script>
(function(){
  const KEYS = {
    entries: 'studyEntries_v1',
    cats: 'studyCategories_v1',
    goal: 'studyGoal_v1'
  };

  /*** ユーティリティ ***/
  const pad = n => String(n).padStart(2,'0');
  const todayStr = () => {
    const d = new Date(); return [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate())].join('-');
  };
  const fmtDateLabel = (d) => \`\${d.getFullYear()}年\${d.getMonth()+1}月\`;
  const parseDateStr = (s) => { // safe local midnight
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  };
  const dateToStr = (d) => \`\${d.getFullYear()}-\${pad(d.getMonth()+1)}-\${pad(d.getDate())}\`;
  const mondayOf = (d) => {
    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const w = (t.getDay() + 6) % 7; // Mon=0
    t.setDate(t.getDate() - w);
    return t;
  };
  const addDays = (d, n) => { const t = new Date(d); t.setDate(t.getDate()+n); return t; };

  const toast = (msg='保存しました')=>{
    const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1200);
  };

  /*** ストレージ ***/
  const load = (k, fallback) => {
    try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fallback; }
    catch(e){ return fallback; }
  };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  /*** 初期データ ***/
  let entries = load(KEYS.entries, []);
  let categories = load(KEYS.cats, [
    'IELTSリーディング','単語','スピーキング','リスニング','文法','ライティング'
  ]);
  let goal = load(KEYS.goal, null);

  /*** DOM 参照 ***/
  const tabsEl = document.getElementById('tabs');
  const tabBtns = [...tabsEl.querySelectorAll('.tab-btn[data-tab]')];
  const sections = {
    input: document.getElementById('tab-input'),
    month: document.getElementById('tab-month'),
    week:  document.getElementById('tab-week'),
    goal:  document.getElementById('tab-goal'),
    cats:  document.getElementById('tab-cats'),
  };

  /* 入力フォーム */
  const form = document.getElementById('entryForm');
  const dateEl = document.getElementById('date');
  const minEl = document.getElementById('minutes');
  const catSel = document.getElementById('category');
  const startTimeEl = document.getElementById('startTime');
  const endTimeEl = document.getElementById('endTime');
  let manualTimes = false; // 手動編集済みなら推定で上書きしない
  const recentList = document.getElementById('recentList');

  /* 月カレンダー */
  const dowRow = document.getElementById('dowRow');
  const monthGrid = document.getElementById('monthGrid');
  const monthTitle = document.getElementById('monthTitle');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  const thisMonthBtn = document.getElementById('thisMonth');
  const dayDetails = document.getElementById('dayDetails');
  const DOW = ['月','火','水','木','金','土','日']

  /* 週 */
  const weekBars = document.getElementById('weekBars');
  const weekTable = document.getElementById('weekTable');
  const weekTotalHint = document.getElementById('weekTotalHint');

  /* 目標 */
  const goalForm = document.getElementById('goalForm');
  const goalStart = document.getElementById('goalStart');
  const goalEnd = document.getElementById('goalEnd');
  const goalHours = document.getElementById('goalHours');
  const deleteGoalBtn = document.getElementById('deleteGoal');
  const goalBar = document.getElementById('goalBar');
  const goalAccum = document.getElementById('goalAccum');
  const goalTarget = document.getElementById('goalTarget');
  const goalPct = document.getElementById('goalPct');
  const goalRangeHint = document.getElementById('goalRangeHint');
  const goalDaysLeft = document.getElementById('goalDaysLeft');

  /* カテゴリ */
  const newCat = document.getElementById('newCat');
  const addCatBtn = document.getElementById('addCat');
  const catList = document.getElementById('catList');
  const resetData = document.getElementById('resetData');

  /* 取込/書出し */
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');

  /*** タブ ***/
  function setTab(name){
    for(const btn of tabBtns){
      // 記録は擬似タブなのでactiveは月に合わせる
      const isActive = (name==='month' && btn.dataset.tab==='month') ||
                       (name!=='month' && btn.dataset.tab===name);
      btn.classList.toggle('active', isActive);
    }
    // まず全部隠す
    Object.values(sections).forEach(sec => sec.style.display = 'none');
    // 月タブのときは「月」と「入力」を縦に並べて表示
    if(name==='month'){
      sections.month.style.display = 'block';
      sections.input.style.display = 'block';
      renderMonth();
    }else{
      sections[name].style.display = 'block';
      if(name==='week')  renderWeek();
      if(name==='goal')  renderGoal();
      if(name==='cats')  renderCats();
    }
  }
  tabsEl.addEventListener('click', (e)=>{
    const t = e.target.closest('.tab-btn[data-tab]'); if(!t) return;
    const name = t.dataset.tab;
    if(name==='input'){
      // 記録ボタンは月タブを表示して入力へスクロール
      setTab('month');
      document.getElementById('tab-input').scrollIntoView({behavior:'smooth', block:'start'});
      return;
    }
    setTab(name);
  });

  /*** 入力レンダリング ***/
  function renderCategorySelect(){
    catSel.innerHTML = '';
    categories.forEach(c=>{
      const opt=document.createElement('option'); opt.value=c; opt.textContent=c; catSel.appendChild(opt);
    });
  }
  function renderRecent(){
    const last = [...entries].sort((a,b)=> b.createdAt - a.createdAt).slice(0,10);
    recentList.innerHTML = last.map(e=>{
      const timeText = (e.startTime && e.endTime) ? \`（\${e.startTime}→\${e.endTime}）\` : '';
      return \`<div class="item">
        <div>
          <div><strong>\${e.date}</strong> <span class="chip">\${e.category}</span></div>
          <div class="muted" style="font-size:12px">\${e.minutes} 分 \${timeText}</div>
        </div>
        <button class="tab-btn btn-sm danger" data-del="\${e.id}">削除</button>
      </div>\`;
    }).join('') || \`<div class="hint">まだ記録がありません。</div>\`;
  }
  recentList.addEventListener('click', (e)=>{
    const id = e.target?.dataset?.del; if(!id) return;
    entries = entries.filter(x=>String(x.id)!==String(id));
    save(KEYS.entries, entries); toast('削除しました');
    renderAll();
  });

  function hhmm(d){ return \`\${pad(d.getHours())}:\${pad(d.getMinutes())}\`; }

  function estimateTimes(){
    // minutes と 日付が今日の場合に、現在時刻から逆算。手動編集済みなら上書きしない。
    const minsRaw = (minEl.value || '').trim();
    const mins = parseInt(minsRaw, 10);
    if(!Number.isFinite(mins) || mins<=0) return;
    if(dateEl.value !== todayStr()) return;
    if(manualTimes) return;
    const end = new Date();
    const start = new Date(end.getTime() - mins*60000);
    startTimeEl.value = hhmm(start);
    endTimeEl.value   = hhmm(end);
  }
  minEl.addEventListener('input', estimateTimes);
  dateEl.addEventListener('change', ()=>{ manualTimes=false; estimateTimes(); });
  startTimeEl.addEventListener('input', ()=>{ manualTimes = true; });
  endTimeEl.addEventListener('input',   ()=>{ manualTimes = true; });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const minutes = parseInt((minEl.value||'').trim(), 10);
    if(!Number.isFinite(minutes) || minutes<=0) return;

    // 推定が未確定ならここで一度だけ自動算出
    if(!manualTimes && (!startTimeEl.value || !endTimeEl.value) && dateEl.value === todayStr()){
      estimateTimes();
    }

    const rec = {
      id: Date.now().toString(36),
      date: dateEl.value || todayStr(),
      minutes,
      category: catSel.value,
      createdAt: Date.now(),
      startTime: startTimeEl.value || null,
      endTime:   endTimeEl.value   || null
    };
    entries.push(rec);
    save(KEYS.entries, entries);

    // 入力クリア（時刻は継続利用しない）
    minEl.value = '';
    if(dateEl.value===todayStr()){ manualTimes=false; estimateTimes(); } else { startTimeEl.value = ''; endTimeEl.value=''; manualTimes=false; }
    toast();
    renderAll();
  });

  /*** 月カレンダー ***/
  let currentYM = {y: new Date().getFullYear(), m: new Date().getMonth()};
  function renderMonth(){
    // 曜日ヘッダ（Mon〜Sun）
    dowRow.innerHTML = DOW.map(d=>\`<div class="dow">\${d}</div>\`).join('');

    const y = currentYM.y, m = currentYM.m;
    monthTitle.textContent = fmtDateLabel(new Date(y,m,1));

    // 月内の各日の合計
    const lastDate = new Date(y, m+1, 0).getDate();
    const totals = {};
    let monthMax = 0;
    for(let d=1; d<=lastDate; d++){
      const key = \`\${y}-\${pad(m+1)}-\${pad(d)}\`;
      const sum = entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);
      totals[key] = sum; monthMax = Math.max(monthMax, sum);
    }
    const firstDow = (new Date(y,m,1).getDay()+6)%7; // Mon start
    const blanks = Array.from({length:firstDow}, ()=>'<div></div>').join('');

    monthGrid.innerHTML = blanks + Array.from({length:lastDate}, (_,i)=>{
      const d=i+1, key = \`\${y}-\${pad(m+1)}-\${pad(d)}\`, sum = totals[key]||0;
      const level = sum===0 ? 0 : Math.min(4, Math.ceil((sum/(monthMax||1))*4));
      const isToday = key===todayStr();
      return \`<div class="day lvl\${level} \${isToday?'today':''}" data-date="\${key}">
        <div class="num">\${d}</div>
        <div class="mins">\${sum? sum+'分':''}</div>
      </div>\`;
    }).join('');

    dayDetails.innerHTML = \`<div class="hint">日付をタップすると、その日の詳細が表示されます。</div>\`;
  }
  monthGrid.addEventListener('click', (e)=>{
    const d = e.target.closest('.day')?.dataset?.date; if(!d) return;
    const list = entries.filter(x=>x.date===d).sort((a,b)=>b.createdAt-a.createdAt);
    const total = list.reduce((a,b)=>a+b.minutes,0);
    dayDetails.innerHTML = \`
      <div class="item">
        <div><strong>\${d}</strong></div>
        <div>合計 <strong>\${total}</strong> 分</div>
      </div>
      \${ list.map(e=>\`
        <div class="item">
          <div>
            <div><span class="chip">\${e.category}</span></div>
            <div class="muted" style="font-size:12px">\${e.minutes} 分 \${e.startTime && e.endTime ? '（'+e.startTime+'→'+e.endTime+'）':''}</div>
          </div>
          <button class="tab-btn btn-sm danger" data-del="\${e.id}">削除</button>
        </div>
      \`).join('') || \`<div class="hint">記録なし</div>\`}
    \`;
  });
  dayDetails.addEventListener('click', (e)=>{
    const id = e.target?.dataset?.del; if(!id) return;
    entries = entries.filter(x=>String(x.id)!==String(id));
    save(KEYS.entries, entries); toast('削除しました');
    renderAll();
  });
  prevMonthBtn.addEventListener('click', ()=>{
    if(currentYM.m===0){ currentYM.y--; currentYM.m=11; } else currentYM.m--;
    renderMonth();
  });
  nextMonthBtn.addEventListener('click', ()=>{
    if(currentYM.m===11){ currentYM.y++; currentYM.m=0; } else currentYM.m++;
    renderMonth();
  });
  thisMonthBtn.addEventListener('click', ()=>{
    const d=new Date(); currentYM={y:d.getFullYear(), m:d.getMonth()}; renderMonth();
  });

  /*** 週ビュー ***/
  function renderWeek(){
    // 直近8週間（現在週含む）
    const today = new Date();
    const startThisWeek = mondayOf(today);
    const weeks = [];
    for(let i=7; i>=0; i--){
      const start = addDays(startThisWeek, -7*i);
      const end = addDays(start, 6);
      const sum = entries.filter(e=>{
        const t = parseDateStr(e.date);
        return t>=start && t<=end;
      }).reduce((a,b)=>a+b.minutes,0);
      weeks.push({start, end, sum});
    }
    const max = Math.max(...weeks.map(w=>w.sum), 1);
    weekBars.innerHTML = weeks.map(w=>{
      const h = Math.round((w.sum/max)*100);
      const label = \`\${pad(w.start.getMonth()+1)}/\${pad(w.start.getDate())}\`;
      return \`<div class="bar" title="\${label}〜\${pad(w.end.getMonth()+1)}/\${pad(w.end.getDate())}：\${w.sum}分">
        <div class="val">\${w.sum}</div>
        <div class="col" style="height:\${h}%"></div>
        <label>\${label}</label>
      </div>\`;
    }).join('');

    weekTable.innerHTML = weeks.slice().reverse().map(w=>{
      return \`<div class="item">
        <div>\${w.start.getFullYear()}/\${pad(w.start.getMonth()+1)}/\${pad(w.start.getDate())} 〜 \${pad(w.end.getMonth()+1)}/\${pad(w.end.getDate())}</div>
        <div><strong>\${w.sum}</strong> 分</div>
      </div>\`;
    }).join('');

    const total8 = weeks.reduce((a,b)=>a+b.sum,0);
    weekTotalHint.textContent = \`合計: \${total8} 分（直近8週）\`;
  }

  /*** 目標 ***/
  function renderGoal(){
    if(goal){
      goalStart.value = goal.start;
      goalEnd.value   = goal.end;
      goalHours.value = Math.round(goal.targetMin/60);
    }
    const hint = goal ? \`\${goal.start}〜\${goal.end}\` : '未設定';
    goalRangeHint.textContent = hint;

    let accum = 0, target = 0, pct = 0, left = '';
    if(goal){
      const s = parseDateStr(goal.start), e = parseDateStr(goal.end);
      accum = entries.filter(x=>{
        const d = parseDateStr(x.date);
        return d>=s && d<=e;
      }).reduce((a,b)=>a+b.minutes,0);
      target = goal.targetMin;
      pct = Math.min(100, Math.round((accum/Math.max(1,target))*100));
      const daysLeft = Math.max(0, Math.ceil((e - new Date())/86400000));
      left = \`終了まで残り \${daysLeft} 日\`;
    }
    goalBar.style.width = pct + '%';
    goalAccum.textContent = \`\${accum.toLocaleString()} 分\`;
    goalTarget.textContent = target ? \`\${target.toLocaleString()} 分\` : '—';
    goalPct.textContent = target ? \`\${pct}%\` : '—';
    goalDaysLeft.textContent = left;
  }
  goalForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const start = goalStart.value, end = goalEnd.value, hours = Number(goalHours.value||0);
    if(!start || !end || !hours) return;
    goal = {start, end, targetMin: hours*60};
    save(KEYS.goal, goal); toast('目標を保存しました');
    renderGoal();
  });
  deleteGoalBtn.addEventListener('click', ()=>{
    if(!confirm('目標を削除しますか？')) return;
    goal = null; localStorage.removeItem(KEYS.goal); renderGoal(); toast('目標を削除しました');
  });

  /*** カテゴリ管理 ***/
  function renderCats(){
    catList.innerHTML = categories.map((c,i)=>\`
      <div class="item">
        <div>\${c}</div>
        <div class="inline">
          <button class="tab-btn btn-sm" data-up="\${i}">↑</button>
          <button class="tab-btn btn-sm" data-down="\${i}">↓</button>
          <button class="tab-btn btn-sm danger" data-del="\${i}">削除</button>
        </div>
      </div>
    \`).join('') || \`<div class="hint">カテゴリがありません。追加してください。</div>\`;
  }
  addCatBtn.addEventListener('click', ()=>{
    const name = (newCat.value||'').trim();
    if(!name) return;
    if(categories.includes(name)){ toast('既に存在します'); return; }
    categories.push(name); save(KEYS.cats, categories);
    newCat.value=''; renderCategorySelect(); renderCats(); toast('カテゴリを追加しました');
  });
  catList.addEventListener('click', (e)=>{
    const i = e.target?.dataset?.del;
    if(i!==undefined){
      const name = categories[i];
      const used = entries.some(x=>x.category===name);
      if(used){ alert('このカテゴリの記録が存在します。先に記録を変更/削除してください。'); return; }
      categories.splice(i,1); save(KEYS.cats, categories);
      renderCategorySelect(); renderCats(); toast('削除しました'); return;
    }
    const up = e.target?.dataset?.up, down = e.target?.dataset?.down;
    if(up!==undefined){
      const idx = Number(up); if(idx>0){
        [categories[idx-1], categories[idx]] = [categories[idx], categories[idx-1]];
        save(KEYS.cats, categories); renderCategorySelect(); renderCats();
      }
    }
    if(down!==undefined){
      const idx = Number(down); if(idx<categories.length-1){
        [categories[idx+1], categories[idx]] = [categories[idx], categories[idx+1]];
        save(KEYS.cats, categories); renderCategorySelect(); renderCats();
      }
    }
  });

  resetData.addEventListener('click', ()=>{
    if(!confirm('本当に全データ（記録・カテゴリ・目標）を削除しますか？')) return;
    localStorage.removeItem(KEYS.entries);
    localStorage.removeItem(KEYS.cats);
    localStorage.removeItem(KEYS.goal);
    entries=[]; categories=['IELTSリーディング','単語','スピーキング','リスニング','文法','ライティング']; goal=null;
    save(KEYS.cats, categories);
    renderAll(); toast('初期化しました');
  });

  /*** JSON エクスポート/インポート ***/
  exportBtn.addEventListener('click', ()=>{
    const data = {entries, categories, goal, exportedAt: new Date().toISOString()};
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = \`study_backup_\${Date.now()}.json\`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  importBtn.addEventListener('click', ()=>importFile.click());
  importFile.addEventListener('change', async ()=>{
    const f = importFile.files[0]; if(!f) return;
    const text = await f.text();
    try{
      const data = JSON.parse(text);
      if(!data || !Array.isArray(data.entries)) throw new Error('不正な形式');
      entries = data.entries; categories = data.categories || categories; goal = data.goal || null;
      save(KEYS.entries, entries); save(KEYS.cats, categories); save(KEYS.goal, goal);
      renderAll(); toast('読み込みました');
    }catch(err){
      alert('読み込みに失敗しました: ' + err.message);
    }finally{
      importFile.value='';
    }
  });

  /*** まとめレンダリング ***/
  function renderAll(){
    renderCategorySelect();
    renderRecent();
    renderMonth();
    renderWeek();
    renderGoal();
  }

  /*** 初期化 ***/
  function init(){
    dateEl.value = todayStr();
    setTab('month');      // 初期表示は「月」
    renderAll();
  }
  init();

})();
</script>
</body>
</html>
