<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
  <title>å‹‰å¼·è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
  <style>
    :root{
      --bg: #0f1115;
      --card: #171a21;
      --text: #dfe6ee;
      --muted: #98a2b3;
      --accent: #4ea46e;
      --accent-2:#2c7a4a;
      --danger:#f25f5c;
      --lvl0:#2a2e36;
      --lvl1:#284e32;
      --lvl2:#2f6e3e;
      --lvl3:#2f8e4a;
      --lvl4:#31a65a;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --card: #ffffff;
        --text:#111;
        --muted:#667085;
        --accent:#2ea043;
        --accent-2:#1f7a32;
        --lvl0:#ebedf0;
        --lvl1:#c6e48b;
        --lvl2:#7bc96f;
        --lvl3:#239a3b;
        --lvl4:#196127;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
      line-height:1.5;
    }
    header{
      position:sticky;top:0;z-index:5;background:var(--bg);
      padding:12px 12px 8px;border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{margin:0;font-size:18px}
    .tabs{display:flex;gap:8px;margin-top:8px;overflow:auto;padding-bottom:4px;}
    .tab-btn{white-space:nowrap;border:1px solid rgba(255,255,255,.12);background:var(--card);color:var(--text);padding:8px 12px;border-radius:999px;font-size:13px;}
    .tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(78,164,110,.2) inset}
    main{padding:12px;max-width:980px;margin:0 auto}
    section{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-bottom:12px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0e1016;color:var(--text);font-size:15px;}
    @media (prefers-color-scheme: light){input,select,button,textarea{background:#fff;color:#111;border-color:#e5e7eb}}
    button.primary{background:var(--accent);color:white;border:none;font-weight:600}
    button.secondary{background:transparent}
    .inline{display:flex;gap:8px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#10131a;border:1px solid rgba(255,255,255,.08);font-size:12px}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    /* --- summary card --- */
    .summary-card {
      background: var(--card);
      border: 1.5px solid var(--accent);
      border-radius: 14px;
      margin-bottom: 18px;
      padding: 18px 14px 12px 14px;
      display: flex; flex-direction: column; gap: 8px;
      font-size: 15px;
    }
    .summary-kpi { font-size: 26px; font-weight: bold; }
    .summary-list { display: grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; }
    @media (max-width:600px) {.summary-list { grid-template-columns:1fr; } }
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .calendar-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .calendar-grid{display:grid;gap:4px;grid-template-columns:repeat(7,1fr);}
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .day{aspect-ratio:1/1;border-radius:6px;padding:4px;position:relative;display:flex;flex-direction:column;justify-content:space-between;background:var(--lvl0);cursor:pointer;}
    .day .num{font-size:12px;opacity:.9}
    .day .mins{font-size:11px;text-align:right;opacity:.95}
    .lvl0{background:var(--lvl0)}
    .lvl1{background:var(--lvl1)}
    .lvl2{background:var(--lvl2)}
    .lvl3{background:var(--lvl3)}
    .lvl4{background:var(--lvl4)}
    .day.today{outline:2px solid var(--accent);outline-offset:0}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:#0d0f15;}
    @media (prefers-color-scheme: light){.item{background:#fff;border-color:#e5e7eb}}
    .item button.tab-btn[data-del]{padding:4px 8px;font-size:11px;}
    .footer-note{font-size:11px;color:var(--muted);text-align:center;margin:16px 0 32px}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#11161c;color:#dfe6ee;padding:10px 14px;border:1px solid rgba(255,255,255,.08);border-radius:999px;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1}
    /* è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ */
    .form-row-flex {
      display: flex; gap: 12px; align-items: flex-end; margin-bottom:4px;
    }
    @media (max-width:600px) {.form-row-flex { flex-direction:column; align-items:stretch; gap:4px;} }
    .input-block { flex:1; }
    .time-input-row {
      display: flex; gap: 8px; align-items: center; margin-top: 6px;
    }
    .time-input-row label { font-size:12px; color:var(--muted);}
    .time-input-row input {
      width: 110px; min-width: 80px; text-align:center;
      padding:10px;
    }
    @media (max-width:600px) {.time-input-row input{width:100%; min-width:0;}}
    /* ç›®æ¨™ãƒœã‚¿ãƒ³æ•´åˆ— */
    .goal-btns {
      display:flex;gap:8px;justify-content:center;margin-top:12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“˜ å‹‰å¼·è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="month">æœˆ</button>
      <button class="tab-btn" data-tab="goal">ç›®æ¨™</button>
      <button class="tab-btn" data-tab="cats">ã‚«ãƒ†ã‚´ãƒª</button>
      <button class="tab-btn right" id="exportBtn" title="JSONã§æ›¸ãå‡ºã—">ğŸ“¤</button>
      <button class="tab-btn" id="importBtn" title="JSONã‚’èª­ã¿è¾¼ã¿">ğŸ“¥</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>
  </header>
  <main>
    <section id="tab-month">
      <!-- ç·åˆã‚µãƒãƒªãƒ¼ -->
      <div id="summaryCard" class="summary-card"></div>
      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <div class="calendar-head">
        <button id="prevMonth" class="tab-btn">â†</button>
        <div id="monthTitle" style="font-weight:700"></div>
        <button id="nextMonth" class="tab-btn">â†’</button>
        <button id="thisMonth" class="tab-btn">ä»Šæœˆ</button>
      </div>
      <div class="calendar-grid" id="dowRow"></div>
      <div class="calendar-grid" id="monthGrid"></div>
      <div id="dayDetails" style="margin-top:10px"></div>
      <!-- è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <form id="entryForm" style="margin-top:18px">
        <div class="form-row-flex">
          <div class="input-block">
            <label>æ—¥ä»˜</label>
            <input type="date" id="date" required>
          </div>
          <div class="input-block">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="category"></select>
          </div>
          <div class="input-block">
            <label>æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
            <input type="text" id="minutes" placeholder="ä¾‹: 45" required autocomplete="off">
          </div>
        </div>
        <div class="time-input-row">
          <label>é–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»</label>
          <input type="text" id="startTime" maxlength="5" placeholder="HH:MM">
          <span>ï½</span>
          <input type="text" id="endTime" maxlength="5" placeholder="HH:MM">
          <button type="submit" class="primary" style="min-width:90px">è¨˜éŒ²ã™ã‚‹</button>
        </div>
      </form>
      <div style="margin-top:12px">
        <strong>ç›´è¿‘ã®è¨˜éŒ²</strong>
        <div class="list" id="recentList"></div>
      </div>
    </section>
    <!-- ç›®æ¨™ -->
    <section id="tab-goal" style="display:none">
      <form id="goalForm">
        <div class="row">
          <div>
            <label>é–‹å§‹æ—¥</label>
            <input type="date" id="goalStart" required>
          </div>
          <div>
            <label>çµ‚äº†æ—¥</label>
            <input type="date" id="goalEnd" required>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>ç›®æ¨™æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
            <input type="number" id="goalHours" min="1" placeholder="ä¾‹: 100" required>
          </div>
        </div>
        <div class="goal-btns">
          <button class="primary" type="submit">ä¿å­˜</button>
          <button class="tab-btn danger" type="button" id="goalDeleteBtn">å‰Šé™¤</button>
        </div>
      </form>
      <div class="progress-wrap" style="margin-top:12px">
        <div class="inline" style="justify-content:space-between">
          <div><strong>ç›®æ¨™é”æˆç‡</strong></div>
          <div class="hint" id="goalRangeHint"></div>
        </div>
        <div class="progress" style="margin-top:8px">
          <div id="goalBar"></div>
        </div>
        <div class="kpis">
          <div class="item"><div>ç´¯è¨ˆ</div><div id="goalAccum" style="font-weight:700"></div></div>
          <div class="item"><div>ç›®æ¨™</div><div id="goalTarget" style="font-weight:700"></div></div>
          <div class="item"><div>é”æˆç‡</div><div id="goalPct" style="font-weight:700"></div></div>
        </div>
        <div class="hint" id="goalDaysLeft" style="margin-top:6px"></div>
      </div>
    </section>
    <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
    <section id="tab-cats" style="display:none">
      <div class="row">
        <div>
          <label>æ–°è¦ã‚«ãƒ†ã‚´ãƒªå</label>
          <input type="text" id="newCat" placeholder="ä¾‹: IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°">
        </div>
        <div style="align-self:end">
          <button id="addCat" class="primary" type="button">è¿½åŠ </button>
        </div>
      </div>
      <div style="margin-top:8px" id="catList" class="list"></div>
      <div class="inline" style="margin-top:12px; gap:8px">
        <button id="resetData" class="tab-btn danger" type="button">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
    </section>
    <div class="footer-note">v3.0 / ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œ</div>
  </main>
  <div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>
  <script>
  (()=> {
    const KEYS = {entries:'studyEntries_v3',cats:'studyCategories_v3',goal:'studyGoal_v3'};
    const pad=n=>String(n).padStart(2,'0');
    const todayStr=()=>{const d=new Date();return [d.getFullYear(),pad(d.getMonth()+1),pad(d.getDate())].join('-');};
    const fmtDateLabel=d=>`${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
    const parseDateStr=s=>{const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,0,0,0,0);};
    const dateToStr=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const toast=msg=>{const t=document.getElementById('toast');t.textContent=msg||'ä¿å­˜ã—ã¾ã—ãŸ';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);}
    const load=(k,fallback)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??fallback}catch(e){return fallback}};
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    let entries=load(KEYS.entries,[]),categories=load(KEYS.cats,['IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°','å˜èª','ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°','ãƒªã‚¹ãƒ‹ãƒ³ã‚°','æ–‡æ³•','ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°']),goal=load(KEYS.goal,null);

    // --- ã‚¿ãƒ–
    const tabBtns=[...document.querySelectorAll('.tab-btn[data-tab]')];
    const sections={
      month:document.getElementById('tab-month'),
      goal:document.getElementById('tab-goal'),
      cats:document.getElementById('tab-cats')
    };
    function setTab(name){
      for(const btn of tabBtns){btn.classList.toggle('active',btn.dataset.tab===name);}
      Object.entries(sections).forEach(([k,sec])=>{sec.style.display=(k===name)?'block':'none';});
      if(name==='month') {renderSummary(); renderMonth();}
      if(name==='goal') renderGoal();
      if(name==='cats') renderCats();
    }
    document.getElementById('tabs').addEventListener('click',e=>{
      const t=e.target.closest('.tab-btn[data-tab]');if(!t)return;setTab(t.dataset.tab);
    });

    // --- ã‚µãƒãƒªãƒ¼
    function renderSummary() {
      const wrap = document.getElementById('summaryCard');
      if (!entries.length) {
        wrap.innerHTML = '<div class="muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return;
      }
      // åˆè¨ˆ
      const totalMin = entries.reduce((a,b)=>a+b.minutes,0);
      const totalH = (totalMin/60).toFixed(1);
      // é–‹å§‹æ—¥ãƒ»æ—¥æ•°
      const dates = entries.map(e=>e.date).sort();
      const firstDate = dates[0], lastDate = todayStr();
      const days = ( (new Date(lastDate)-parseDateStr(firstDate)) / 86400000 ) + 1;
      // ç›®æ¨™
      let tgt = 0, pct = 0, predict = '';
      if (goal) {
        tgt = goal.targetMin;
        pct = Math.min(100, Math.round((totalMin / Math.max(1,tgt))*100));
        // äºˆæ¸¬æ—¥æ•°
        const avg = totalMin/days;
        if (avg > 0 && totalMin < tgt) {
          const remain = tgt-totalMin;
          const estDays = Math.ceil(remain/avg);
          const d = new Date();
          d.setDate(d.getDate()+estDays);
          predict = `${estDays}æ—¥å¾Œï¼ˆ${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}ï¼‰`;
        } else if (totalMin >= tgt) {
          predict = 'é”æˆæ¸ˆã¿';
        }
      }
      wrap.innerHTML = `
        <div class="summary-kpi">åˆè¨ˆ ${totalMin.toLocaleString()} åˆ†ï¼ˆ${totalH} æ™‚é–“ï¼‰</div>
        <div class="summary-list">
          <div>è¨˜éŒ²é–‹å§‹ã‹ã‚‰ <span style="font-weight:600">${days}</span> æ—¥é–“</div>
          <div>ç›®æ¨™ï¼š${tgt?tgt.toLocaleString()+'åˆ†':'â€”'}ï¼ˆé”æˆç‡${pct||0}%ï¼‰</div>
          <div>ç›®æ¨™åˆ°é”äºˆæ¸¬ï¼š${predict||'â€”'}</div>
        </div>
      `;
    }

    // --- ã‚«ãƒ†ã‚´ãƒª
    const catSel=document.getElementById('category');
    function renderCategorySelect(){catSel.innerHTML='';categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;catSel.appendChild(o);});}

    // --- è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã¨è¨˜éŒ²ãƒªã‚¹ãƒˆ
    const form=document.getElementById('entryForm'),dateEl=document.getElementById('date'),minEl=document.getElementById('minutes'),
      startEl=document.getElementById('startTime'),endEl=document.getElementById('endTime'),recentList=document.getElementById('recentList');

    function renderRecent(){
      const last=[...entries].sort((a,b)=>b.createdAt-a.createdAt).slice(0,10);
      recentList.innerHTML=last.map(e=>`<div class="item"><div><div><strong>${e.date}</strong> <span class="chip">${e.category}</span></div>
        <div class="muted" style="font-size:12px">${e.minutes}åˆ†${(e.startTime&&e.endTime)?`ï¼ˆ${e.startTime}ï½${e.endTime}ï¼‰`:''}</div>
        </div>
        <button class="tab-btn" data-del="${e.id}">å‰Šé™¤</button>
      </div>`).join('')||`<div class="hint">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    }
    recentList.addEventListener('click',e=>{
      const id=e.target?.dataset?.del;if(!id)return;
      entries=entries.filter(x=>String(x.id)!==String(id));save(KEYS.entries,entries);toast('å‰Šé™¤ã—ã¾ã—ãŸ');renderAll();
    });

    // è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ : æ™‚é–“ã‚’å…¥åŠ›ã—ãŸã‚‰é–‹å§‹ãƒ»çµ‚äº†è‡ªå‹•è£œå®Œï¼ˆæœ¬æ—¥ãªã‚‰ç¾åœ¨æ™‚åˆ»æ¨å®šï¼‰
    function estimateTimes(){
      const mins=Number(minEl.value||0);if(!mins){return;}
      if(dateEl.value!==todayStr()){return;}
      const end=new Date(),start=new Date(end.getTime()-mins*60000);
      const fmt=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
      startEl.value=fmt(start);endEl.value=fmt(end);
    }
    minEl.addEventListener('input',estimateTimes);
    dateEl.addEventListener('change',estimateTimes);

    // è¨˜éŒ²
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const minutes=Number(minEl.value),cat=catSel.value,st=startEl.value,endt=endEl.value;
      if(!minutes||minutes<=0||!cat)return;
      entries.push({id:Date.now().toString(36),date:dateEl.value||todayStr(),minutes,category:cat,createdAt:Date.now(),startTime:st,endTime:endt});
      save(KEYS.entries,entries);minEl.value='';estimateTimes();toast();renderAll();
    });

    // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    const dowRow=document.getElementById('dowRow'),monthGrid=document.getElementById('monthGrid'),monthTitle=document.getElementById('monthTitle'),prevMonthBtn=document.getElementById('prevMonth'),nextMonthBtn=document.getElementById('nextMonth'),thisMonthBtn=document.getElementById('thisMonth'),dayDetails=document.getElementById('dayDetails');
    const DOW=['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
    let currentYM={y:new Date().getFullYear(),m:new Date().getMonth()};
    function renderMonth(){
      dowRow.innerHTML=DOW.map(d=>`<div class="dow">${d}</div>`).join('');
      const y=currentYM.y,m=currentYM.m;monthTitle.textContent=fmtDateLabel(new Date(y,m,1));
      const lastDate=new Date(y,m+1,0).getDate();const totals={};let monthMax=0;
      for(let d=1;d<=lastDate;d++){const key=`${y}-${pad(m+1)}-${pad(d)}`;const sum=entries.filter(e=>e.date===key).reduce((a,b)=>a+b.minutes,0);totals[key]=sum;monthMax=Math.max(monthMax,sum);}
      const firstDow=(new Date(y,m,1).getDay()+6)%7;const blanks=Array.from({length:firstDow},()=>'<div></div>').join('');
      monthGrid.innerHTML=blanks+Array.from({length:lastDate},(_,i)=>{
        const d=i+1,key=`${y}-${pad(m+1)}-${pad(d)}`,sum=totals[key]||0;
        const level=sum===0?0:Math.min(4,Math.ceil((sum/(monthMax||1))*4));const isToday=key===todayStr();
        return `<div class="day lvl${level} ${isToday?'today':''}" data-date="${key}"><div class="num">${d}</div><div class="mins">${sum?sum+'åˆ†':''}</div></div>`;
      }).join('');
      dayDetails.innerHTML=`<div class="hint">æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®æ—¥ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>`;
    }
    monthGrid.addEventListener('click',e=>{
      const d=e.target.closest('.day')?.dataset?.date;if(!d)return;
      const list=entries.filter(x=>x.date===d).sort((a,b)=>b.createdAt-a.createdAt),total=list.reduce((a,b)=>a+b.minutes,0);
      dayDetails.innerHTML=`
        <div class="item"><div><strong>${d}</strong></div><div>åˆè¨ˆ <strong>${total}</strong> åˆ†</div></div>
        ${list.map(e=>`<div class="item"><div><span class="chip">${e.category}</span></div><div class="muted" style="font-size:12px">${e.minutes}åˆ†${(e.startTime&&e.endTime)?`ï¼ˆ${e.startTime}ï½${e.endTime}ï¼‰`:''}</div>
        <button class="tab-btn" data-del="${e.id}">å‰Šé™¤</button></div>`).join('')||`<div class="hint">è¨˜éŒ²ãªã—</div>`}`;
    });
    prevMonthBtn.addEventListener('click',()=>{if(currentYM.m===0){currentYM.y--;currentYM.m=11;}else currentYM.m--;renderMonth();});
    nextMonthBtn.addEventListener('click',()=>{if(currentYM.m===11){currentYM.y++;currentYM.m=0;}else currentYM.m++;renderMonth();});
    thisMonthBtn.addEventListener('click',()=>{const d=new Date();currentYM={y:d.getFullYear(),m:d.getMonth()};renderMonth();});

    // --- ç›®æ¨™
    const goalForm=document.getElementById('goalForm'),goalStart=document.getElementById('goalStart'),goalEnd=document.getElementById('goalEnd'),goalHours=document.getElementById('goalHours'),
      goalBar=document.getElementById('goalBar'),goalAccum=document.getElementById('goalAccum'),goalTarget=document.getElementById('goalTarget'),goalPct=document.getElementById('goalPct'),
      goalRangeHint=document.getElementById('goalRangeHint'),goalDaysLeft=document.getElementById('goalDaysLeft'),goalDeleteBtn=document.getElementById('goalDeleteBtn');
    function renderGoal(){
      if(goal){goalStart.value=goal.start;goalEnd.value=goal.end;goalHours.value=Math.round(goal.targetMin/60);}
      goalRangeHint.textContent=goal?`${goal.start}ã€œ${goal.end}`:'æœªè¨­å®š';
      let accum=0,target=0,pct=0,left='';
      if(goal){const s=parseDateStr(goal.start),e=parseDateStr(goal.end);
        accum=entries.filter(x=>{const d=parseDateStr(x.date);return d>=s&&d<=e;}).reduce((a,b)=>a+b.minutes,0);
        target=goal.targetMin;pct=Math.min(100,Math.round((accum/Math.max(1,target))*100));const daysLeft=Math.max(0,Math.ceil((e-new Date())/86400000));left=`çµ‚äº†ã¾ã§æ®‹ã‚Š ${daysLeft} æ—¥`;}
      goalBar.style.width=pct+'%';goalAccum.textContent=`${accum.toLocaleString()} åˆ†`;goalTarget.textContent=target?`${target.toLocaleString()} åˆ†`:'â€”';goalPct.textContent=target?`${pct}%`:'â€”';goalDaysLeft.textContent=left;
    }
    goalForm.addEventListener('submit',e=>{
      e.preventDefault();const start=goalStart.value,end=goalEnd.value,hours=Number(goalHours.value||0);if(!start||!end||!hours)return;
      goal={start,end,targetMin:hours*60};save(KEYS.goal,goal);toast('ä¿å­˜');renderGoal();
    });
    goalDeleteBtn.addEventListener('click',()=>{
      if(!confirm('ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
      localStorage.removeItem(KEYS.goal);goal=null;renderGoal();
    });

    // --- ã‚«ãƒ†ã‚´ãƒªç®¡ç†
    const newCat=document.getElementById('newCat'),addCatBtn=document.getElementById('addCat'),catList=document.getElementById('catList'),resetData=document.getElementById('resetData');
    function renderCats(){
      catList.innerHTML=categories.map((c,i)=>`
        <div class="item"><div>${c}</div>
        <div class="inline">
          <button class="tab-btn" data-up="${i}">â†‘</button>
          <button class="tab-btn" data-down="${i}">â†“</button>
          <button class="tab-btn danger" data-del="${i}">å‰Šé™¤</button>
        </div></div>
      `).join('')||`<div class="hint">ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
    }
    addCatBtn.addEventListener('click',()=>{
      const name=(newCat.value||'').trim();if(!name)return;if(categories.includes(name)){toast('æ—¢ã«å­˜åœ¨ã—ã¾ã™');return;}
      categories.push(name);save(KEYS.cats,categories);newCat.value='';renderCategorySelect();renderCats();toast('è¿½åŠ ã—ã¾ã—ãŸ');
    });
    catList.addEventListener('click',e=>{
      const i=e.target?.dataset?.del;if(i!==undefined){
        const name=categories[i],used=entries.some(x=>x.category===name);
        if(used){alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªã®è¨˜éŒ²ãŒå­˜åœ¨ã—ã¾ã™ã€‚å…ˆã«è¨˜éŒ²ã‚’å¤‰æ›´/å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');return;}
        categories.splice(i,1);save(KEYS.cats,categories);renderCategorySelect();renderCats();toast('å‰Šé™¤ã—ã¾ã—ãŸ');return;}
      const up=e.target?.dataset?.up,down=e.target?.dataset?.down;
      if(up!==undefined){const idx=Number(up);if(idx>0){[categories[idx-1],categories[idx]]=[categories[idx],categories[idx-1]];save(KEYS.cats,categories);renderCategorySelect();renderCats();}}
      if(down!==undefined){const idx=Number(down);if(idx<categories.length-1){[categories[idx+1],categories[idx]]=[categories[idx],categories[idx+1]];save(KEYS.cats,categories);renderCategorySelect();renderCats();}}
    });
    resetData.addEventListener('click',()=>{
      if(!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆè¨˜éŒ²ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ç›®æ¨™ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
      localStorage.removeItem(KEYS.entries);localStorage.removeItem(KEYS.cats);localStorage.removeItem(KEYS.goal);
      entries=[];categories=['IELTSãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°','å˜èª','ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°','ãƒªã‚¹ãƒ‹ãƒ³ã‚°','æ–‡æ³•','ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°'];goal=null;
      save(KEYS.cats,categories);renderAll();toast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    });

    // --- JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    document.getElementById('exportBtn').addEventListener('click',()=>{
      const data={entries,categories,goal,exportedAt:new Date().toISOString()};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download=`study_backup_${Date.now()}.json`;a.click();URL.revokeObjectURL(a.href);
    });
    document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change',async()=>{
      const f=document.getElementById('importFile').files[0];if(!f)return;const text=await f.text();
      try{const data=JSON.parse(text);if(!data||!Array.isArray(data.entries))throw new Error('ä¸æ­£ãªå½¢å¼');
        entries=data.entries;categories=data.categories||categories;goal=data.goal||null;
        save(KEYS.entries,entries);save(KEYS.cats,categories);save(KEYS.goal,goal);renderAll();toast('èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
      }catch(err){alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—:'+err.message);}finally{document.getElementById('importFile').value='';}
    });

    // --- ã¾ã¨ã‚
    function renderAll(){renderCategorySelect();renderRecent();renderSummary();renderMonth();renderGoal();renderCats();}
    function init(){dateEl.value=todayStr();estimateTimes();renderAll();}
    init();

  })();
  </script>
</body>
</html>
